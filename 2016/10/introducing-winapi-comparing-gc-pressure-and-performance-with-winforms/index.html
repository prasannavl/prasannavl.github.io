<!DOCTYPE html><html class="nprogress-busy" lang="en"><head><meta charset="utf-8"><meta content="ie=edge" http-equiv="x-ua-compatible"><link href="/css/index.8abdea1f0a4fab97fb2a612d0a6c8fe1.css" rel="stylesheet"><script defer src="/js/runtime.e8b300f0556ed5d0c4aa.js" type="text/javascript"></script><script defer src="/js/vendor.2214c7d88e9dd54634d1.js" type="text/javascript"></script><script defer src="/js/index.e332e09cc7e67f046901.js" type="text/javascript"></script><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MZ2DHR');</script><!-- End Google Tag Manager --><script defer src="/js/chunks/common-index.9d929302abc5499a1dd6.js" type="text/javascript" charset="utf-8"></script><script defer src="/js/chunks/329a8f2cd144f9e2abc99bab9b4125be.49afdb2bdf0071a7aa0a.js" type="text/javascript" charset="utf-8"></script><script defer src="/js/chunks/fd386dadc1cf9935e5882fcfbf40fb5d.414378448a6a68d300e3.js" type="text/javascript" charset="utf-8"></script><title>Introducing WinApi: Comparing GC pressure and performance with WinForms | Prasanna Loganathar</title><link href="/icons/favicon-32x32.png" rel="icon" data-react-helmet="true" sizes="32x32" type="image/png"><link href="/icons/favicon-96x96.png" rel="icon" data-react-helmet="true" sizes="96x96" type="image/png"><link href="/icons/favicon-16x16.png" rel="icon" data-react-helmet="true" sizes="16x16" type="image/png"><link href="/favicon.ico" rel="shortcut icon" data-react-helmet="true" type="image/x-icon"><link href="/icons/apple-touch-icon-57x57.png" rel="apple-touch-icon" data-react-helmet="true" sizes="57x57"><link href="/icons/apple-touch-icon-60x60.png" rel="apple-touch-icon" data-react-helmet="true" sizes="60x60"><link href="/icons/apple-touch-icon-72x72.png" rel="apple-touch-icon" data-react-helmet="true" sizes="72x72"><link href="/icons/apple-touch-icon-76x76.png" rel="apple-touch-icon" data-react-helmet="true" sizes="76x76"><link href="/icons/apple-touch-icon-114x114.png" rel="apple-touch-icon" data-react-helmet="true" sizes="114x114"><link href="/icons/apple-touch-icon-120x120.png" rel="apple-touch-icon" data-react-helmet="true" sizes="120x120"><link href="/icons/apple-touch-icon-144x144.png" rel="apple-touch-icon" data-react-helmet="true" sizes="144x144"><link href="/icons/apple-touch-icon-152x152.png" rel="apple-touch-icon" data-react-helmet="true" sizes="152x152"><link href="/icons/apple-touch-icon-180x180.png" rel="apple-touch-icon" data-react-helmet="true" sizes="180x180"><link href="/icons/safari-pinned-tab.svg" rel="mask-icon" data-react-helmet="true" color="#0096d6"><link href="/manifest.json" rel="manifest" data-react-helmet="true"><link href="https://www.prasannavl.com/rss.xml" rel="alternate" data-react-helmet="true" type="application/rss+xml"><link href="https://www.prasannavl.com/sitemap.xml" rel="sitemap" data-react-helmet="true"><meta content="Prasanna Loganathar's Weblog" data-react-helmet="true" name="description"><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" data-react-helmet="true" name="viewport"><meta content="#0096d6" data-react-helmet="true" name="msapplication-TileColor"><meta content="/icons/mstile-144x144.png" data-react-helmet="true" name="msapplication-TileImage"><meta content="/browserconfig.xml" data-react-helmet="true" name="msapplication-config"><meta content="summary" data-react-helmet="true" name="twitter:card"><meta content="@prasannavl" data-react-helmet="true" name="twitter:site"><meta content="@prasannavl" data-react-helmet="true" name="twitter:creator"><meta content="Introducing WinApi: Comparing GC pressure and performance with WinForms" data-react-helmet="true" name="twitter:title"><meta content="Article on WinApi - Part 4" data-react-helmet="true" name="twitter:description"><meta content="Introducing WinApi: Comparing GC pressure and performance with WinForms" data-react-helmet="true" property="og:title"><meta content="Prasanna Loganathar" data-react-helmet="true" property="og:site_name"><meta content="article" data-react-helmet="true" property="og:type"><meta content="Article on WinApi - Part 4" data-react-helmet="true" property="og:description"><meta content="https://www.prasannavl.com//icons/mstile-310x310.png" data-react-helmet="true" property="og:image"><meta content="http://localhost:45678/2016/10/introducing-winapi-comparing-gc-pressure-and-performance-with-winforms/" data-react-helmet="true" property="og:url"><meta content="Prasanna Loganathar" data-react-helmet="true" property="og:article:author"><meta content="2016-10-29T04:44:36.874Z" data-react-helmet="true" property="og:article:article:published_time"></head><body><!-- Google Tag Manager (noscript) --><noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-MZ2DHR" style="display:none;visibility:hidden" width="0"></iframe></noscript><!-- End Google Tag Manager (noscript) --><div id="root"><div class="app-container container-fluid"><div class="row"><div class="col col-md-8 offset-md-2"><header class="banner"><h1 id="top"><a href="/">Prasanna Loganathar</a></h1><p>Explore more of <a href="/">my blog</a>, <a href="/archives/">archives</a> or subscribe to my <a href="/rss.xml" rel="alternate" type="application/rss+xml">feed</a>.</p><hr></header><main role="main"><article><header class="mb-4"><h1 class="title" rel="title">Introducing WinApi: Comparing GC pressure and performance with WinForms</h1><p class="d-none" rel="author">Prasanna Loganathar</p><p class="small text-muted" rel="date"><time datetime="2016-10-29T04:44:36.874Z">Saturday, 29th Oct 2016</time></p></header><p><b>GitHub: </b><a href="https://github.com/prasannavl/WinApi">WinApi</a></p><div><section class="note"><h4 class="mt-2">TL;DR - Performance stats</h4><ul class="list-dashed list-unstyled m-0"><li>Direct message loop performance: <strong>20-35% faster</strong>.</li><li>Heap allocation: <strong>0MB vs. roughly, 0.75GB</strong> / 100k messages.</li><li>Memory page faults (Soft): <strong>0.005%</strong> - A mere <strong>5k vs. roughly 1 million</strong> faults/100k messages).</li></ul></section></div><p><a href="https://github.com/prasannavl/WinApi">WinApi's</a> primary objective is to provide access to the native layers of the Windows API from the CLR. However, even on first look it should be clear that the <code>WinApi.Windows</code> namespace infringes on the <code>WinForms</code> territory, even though its a tiny sub-fraction of the size of WinForms. Over the years WinForms has been well optimized to be <strong>decent</strong> - It's not the most efficient beast, but for common programs, it probably takes up less than 2-5% percent of your application's time that it doesn't matter on modern hardware - or so is the general line of thought. However, what one cannot refute is that it never was the same as say, <code>ATL/WTL</code> in C++ or direct Win32 programming to be able to handle message loop heavy applications, or high-performance games.</p><h2>The WinApi.Windows advantage</h2><ul><li>The <strong>assembly code generated by the JIT is directly comparable</strong> to <code>ATL/WTL</code> or a Win32 application written by hand.</li><li>The message loop is completely <strong>GC-allocation free</strong>.</li><li>You have <strong>complete control over how messages are processed</strong>. You can entirely short-circuit, or manually extend connection points into the message loop logic.</li><li>It's the perfect replacement for WinForms when you want to handle the GUI logic your own way - has no inherent GUI subclassing and drawing functionality - You're free to use any kind of external GUI logic, and drawing library powered by <code>DirectX</code> (like WPF and WinRT XAML), <code>Cairo</code>, <code>Skia</code> or even the defacto <code>System.Drawing</code> that uses <code>GdiPlus</code> underneath.</li></ul><h2>Performance analysis</h2><h3>Setting the stage</h3><p>Measuring GUI performance, is in general very tricky. Instead, I'm going to skip over the traditional benchmarking models, and do a little trick for a very quick and practically accurate analysis.</p><p>The reason I'm doing this, is not just to do a really quick estimate, but traditional models will be unfair to <code>WinForms</code>. Why? Because, <code>WinApi.Windows</code> is a very efficient and light-weight wrapper. And it has no GC allocations during the message loop. So, a hefty framework like WinForms is always going to lose in micro-performance tests, and the results will be misleading.</p><p>Rather, what I'm going to do, is to open up a simple window and give it a ton of messages to chew. But the idea is that these messages have to go through the entire process loop, but not generate additional calls to other areas such as the graphics API for example, since that would end up benchmarking the 2D, and 3D libraries.</p><p>What's the simplest way to do this? Well, <code>resize the window</code>! Win32 sends off <code>WM_POSITIONCHANGING</code>, <code>WM_POSITIONCHANGED</code>, which in turn generates <code>WM_SIZE</code>, <code>WM_MOVE</code> by the <code>DefWindowProc</code> as you resize. This also ends up generating <code>WM_NCPAINT</code> and <code>WM_PAINT</code> messages as long as the <code>CS_REDRAW</code> styles are set. Perfect - except for the painting part. I do want <code>WM_PAINT</code> being generated since its one of the high-frequency messages, but I just don't want any of graphics API calls.</p><p class="note"><strong>The key here is that, we don't care too much about how quickly the program runs to completion.</strong></p><p>Wait. What? Isn't that the whole point of this? - Not at all. Why? Because, no developer in the right mind would make a program that just goes on resizing itself and call it a useful piece of software. It's way too simple to emulate the conditions of a real-life program to provide any useful timing comparisons. However, the interesting part is that since we trigger the whole layout-paint cycle, we can indeed collect useful information on how the memory allocations take place, memory faults, garbage collections, and a few more - which in turns translates to very significant performance aspects in real-life programs.</p><code>The trick is to use this otherwise useless program to give us useful data that's practically applicable.</code><p class="note"><strong>Note:</strong> Most of the allocations for a program that's as simple as this will likely end up in <code>Generation-0</code>, which will <code>commonly mislead many developers to think its okay</code>. Gen-0 is after-all the most efficient, isn't it? However, in most practical scenarios <code>they get bumped up the generations since a lot of them survive the entire course of the event</code>, and havoc with fragmentation starts to show earlier than most would expect. Large objects are a whole another story which <strong>almost</strong> never gets defragmented during the course of the program.</p><h3>The high-level test program</h3><ul><li>Create a simple window with nothing but 2 labels that are auto-stretched to the entire window.</li><li>The controls should always react to changes, resizing itself and triggering the whole layout-paint cycle, but never painting anything other than its default background until the very end.</li><li>Create one new thread, and keep triggering resize as fast as it can process the messages!</li><li>Stop. Measure. Repeat.</li></ul><p>I'm going to set the thread to send off <code>100,000</code> resize messages, and then stop. 100k may be on the high-side for simple application, but not uncommon for high-performance realtime applications.</p><p class="note"><strong>Note:</strong> This is likely to vary quite a bit depending on the background CPU usage. This particular type of program will also be heavily affected by dynamic CPU clocks, since it may well complete in it's quantum slice, and wait on the next message, <strong>which in turns will affect CPU sleep states</strong>. So, its important to use <code>High-performance mode, or a constant CPU clocking speed</code>. However, the rest is okay, since we don't care too much about how quickly it just finishes.</p><h3>The WinForms program</h3><pre><code><span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">Form1</span> <span class="token punctuation">:</span> <span class="token class-name">Form</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">Form1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">InitializeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> m_times<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">bool</span> m_done<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">DateTime</span> m_startTime<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">DateTime</span> m_endTime<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">int</span> Iterations <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Task</span> m_task<span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnLoad</span><span class="token punctuation">(</span><span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnLoad</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        m_task <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>m_times <span class="token operator">&lt;</span> Iterations<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                m_times<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">SetBounds</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">1200</span> <span class="token operator">-</span> r<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">900</span> <span class="token operator">-</span> r<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            m_endTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span>
            m_done <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">SetBounds</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">700</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_startTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnSizeChanged</span><span class="token punctuation">(</span><span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnSizeChanged</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Paint only after everything's done to show</span>
        <span class="token comment">// the result.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_done<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> str <span class="token operator">=</span> $<span class="token string">"\r\n{DateTime.Now}: No. of changes done: {m_times}"</span><span class="token punctuation">;</span>
        textBox1<span class="token punctuation">.</span>Text <span class="token operator">=</span> str<span class="token punctuation">;</span>

        <span class="token keyword">var</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        sb<span class="token punctuation">.</span><span class="token function">AppendLine</span><span class="token punctuation">(</span>$<span class="token string">"Start Time: {m_startTime}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">AppendLine</span><span class="token punctuation">(</span>$<span class="token string">"End Time: {m_endTime}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">AppendLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>m_endTime <span class="token operator">!=</span> DateTime<span class="token punctuation">.</span>MinValue<span class="token punctuation">)</span>
            sb<span class="token punctuation">.</span><span class="token function">AppendLine</span><span class="token punctuation">(</span>$<span class="token string">"Total Time: {m_endTime - m_startTime}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        textBox2<span class="token punctuation">.</span>Text <span class="token operator">=</span> sb<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>That's it. Very simple! Now, lets run it and wait until it ends.</p><p><img alt="[Image]" class="img-fluid" src="/img/gc-comp-winforms.b783a4608bc703fa84e0f7958fa0ff94.jpg"></p><p>So, on my <code>i7</code> machine, it took about <code>4 minutes and 34 seconds</code>.<br>Okay, now, let's look at the more interesting data.</p><p><img alt="[Image]" class="img-fluid" src="/img/gc-comp-winforms-stat-clr.3d3dcdcb7c05cb4279b8a793659027db.jpg"></p><p>The key data, that's of interest are:</p><div class="note"><ul class="list-dashed list-unstyled m-0"><li>Gen 0 Collections: <strong>370</strong></li><li>Gen 1 Collections: <strong>186</strong></li><li>Finalization Survivors: <strong>1279</strong></li><li>Total Bytes Allocated: <strong>749.18MB</strong></li></ul></div><p>Yikes! That's a lot of allocations. Now, 186 Gen-1 is no small task. Infact, even if we ignore the fact that its Gen-1, and total all of them as Gen-0, its <code>370+186=556</code> collections. That's <strong>one GC collection every 180 messages!</strong>. And so, <strong>totally it allocates three-quarters of a gigabyte of memory for nothing, but just to process the messages</strong> - Add your application logic on top of that - not just for allocations, but also for GCs and more importantly, more of those from Gen 0 could very well have been promoted to Gen 1.</p><p>Clearly, that's a lot of stuff that's going on. Let's just look at a little more data.</p><p><img alt="[Image]" class="img-fluid" src="/img/gc-comp-winforms-stat.daf3a7be5841a8936f077b3b0c3d3aa8.jpg"></p><div class="note"><ul class="list-dashed list-unstyled m-0"><li>Cycles: <strong>514,070,543,274</strong></li><li>Kernel time: <strong>2m:48s</strong></li><li>User time: <strong>0m:46s</strong></li><li>Total time: <strong>3m:34s</strong></li><li>Page faults: <strong>1,119,365</strong></li></ul></div><p>Note that while the <code>page faults</code> here is just the soft faults, it still means certain CPU caches will have to invalidated a lot more. We'll just leave it here. That's sufficient information for making a rough estimate. Let's move on.</p><h3>The WinApi.Windows program</h3><p>Now the same thing with WinApi,</p><pre><code><span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        ApplicationHelpers<span class="token punctuation">.</span><span class="token function">SetupDefaultExceptionHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">var</span> factory <span class="token operator">=</span> WindowFactory<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> win <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">CreateWindow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">MainWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"Hello"</span><span class="token punctuation">,</span> constructionParams<span class="token punctuation">:</span> 
                    <span class="token keyword">new</span> <span class="token class-name">FrameWindowConstructionParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                win<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ApplicationHelpers<span class="token punctuation">.</span><span class="token function">ShowCriticalError</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">MainWindow</span> <span class="token punctuation">:</span> <span class="token class-name">EventedWindowCore</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">int</span> Iterations <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">HorizontalStretchLayout</span> m_layout <span class="token operator">=</span> 
                <span class="token keyword">new</span> <span class="token class-name">HorizontalStretchLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">bool</span> m_done<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">DateTime</span> m_endTime<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">DateTime</span> m_startTime<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">Task</span> m_task<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">StaticBox</span> m_textBox1<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">NativeWindow</span> m_textBox2<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> m_times<span class="token punctuation">;</span>

        <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnCreate</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">CreateWindowPacket</span> packet<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>m_textBox1 <span class="token operator">=</span> StaticBox<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>hParent<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Handle<span class="token punctuation">,</span>
                styles<span class="token punctuation">:</span> WindowStyles<span class="token punctuation">.</span>WS_CHILD <span class="token operator">|</span> WindowStyles<span class="token punctuation">.</span>WS_VISIBLE<span class="token punctuation">,</span> 
                exStyles<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// You can use this to create the static box like this as well. </span>
            <span class="token comment">// But there's rarely any performance benefit in doing so, and</span>
            <span class="token comment">// this doesn't have a WindowProc that's connected.</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>m_textBox2 <span class="token operator">=</span> WindowFactory<span class="token punctuation">.</span><span class="token function">CreateExternalWindow</span><span class="token punctuation">(</span><span class="token string">"static"</span><span class="token punctuation">,</span>
                hParent<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Handle<span class="token punctuation">,</span>
                styles<span class="token punctuation">:</span> WindowStyles<span class="token punctuation">.</span>WS_CHILD <span class="token operator">|</span> WindowStyles<span class="token punctuation">.</span>WS_VISIBLE<span class="token punctuation">,</span>
                exStyles<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>m_layout<span class="token punctuation">.</span>ClientArea <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">GetClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>m_layout<span class="token punctuation">.</span>Margin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rectangle</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>m_layout<span class="token punctuation">.</span>Children<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>m_textBox1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>m_layout<span class="token punctuation">.</span>Children<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>m_textBox2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>m_layout<span class="token punctuation">.</span><span class="token function">PerformLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">var</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>m_task <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
            <span class="token punctuation">{</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>m_times <span class="token operator">&lt;</span> Iterations<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>m_times<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">SetPosition</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span>
                        <span class="token number">1200</span> <span class="token operator">-</span> r<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token number">900</span> <span class="token operator">-</span> r<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>m_endTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>m_done <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">SetPosition</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">700</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>m_startTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span>
            <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnCreate</span><span class="token punctuation">(</span><span class="token keyword">ref</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnSize</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">SizePacket</span> packet<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">var</span> size <span class="token operator">=</span> packet<span class="token punctuation">.</span>Size<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>m_layout<span class="token punctuation">.</span><span class="token function">SetSize</span><span class="token punctuation">(</span><span class="token keyword">ref</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnSize</span><span class="token punctuation">(</span><span class="token keyword">ref</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>m_done<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

            <span class="token keyword">var</span> str <span class="token operator">=</span> $<span class="token string">"\r\n{DateTime.Now}: No. of changes done: {this.m_times}"</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>m_textBox1<span class="token punctuation">.</span><span class="token function">SetText</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">var</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            sb<span class="token punctuation">.</span><span class="token function">AppendLine</span><span class="token punctuation">(</span>$<span class="token string">"Start Time: {this.m_startTime}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">AppendLine</span><span class="token punctuation">(</span>$<span class="token string">"End Time: {this.m_endTime}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">AppendLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>m_endTime <span class="token operator">!=</span> DateTime<span class="token punctuation">.</span>MinValue<span class="token punctuation">)</span> 
                sb<span class="token punctuation">.</span><span class="token function">AppendLine</span><span class="token punctuation">(</span>$<span class="token string">"Total Time: {this.m_endTime - this.m_startTime}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>m_textBox2<span class="token punctuation">.</span><span class="token function">SetText</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>There we go. It does exactly what the WinForms application does. Now, lets run this and see the results.</p><p><img alt="[Image]" class="img-fluid" src="/img/gc-comp-winapi.a630ff65a957d67c35f4546654477ca7.jpg"></p><p>It took about <code>3 minutes and 16 seconds</code>. That's <strong>over a minute faster!</strong>.<br>So, something clearly is more efficient. But why? Let's take a look at the memory stats.</p><p><img alt="[Image]" class="img-fluid" src="/img/gc-comp-winapi-stat-clr.119845beaf2888c6bc2476ca66df1a7b.jpg"></p><div class="note"><ul class="list-dashed list-unstyled m-0"><li>Gen 0 Collections: <strong>0</strong></li><li>Gen 1 Collections: <strong>0</strong></li><li>Finalization Survivors: <strong>0</strong></li><li>Total Bytes Allocated: <strong>0</strong></li></ul></div><p>What!? To be candid, this is quite misleading, though its <em>kinda</em> true. I use the excellent <code>Process Hacker</code> to collect the details of the CLR. However, the way this works is that, its needs to do a GC in order to get these statistics. But what happened here, is that a GC never took place. 100k message loops, but not even a single GC has happened!. That's really cool. Now we're barking up the C/C++ tree, and in style :)</p><p>Let's look at the other bits of data.</p><p><img alt="[Image]" class="img-fluid" src="/img/gc-comp-winapi-stat.25b2a2eae796d80298493032dab24f68.jpg"></p><div class="note"><ul class="list-dashed list-unstyled m-0"><li>Cycles: <strong>328,556,899,144</strong></li><li>Kernel time: <strong>1m:58s</strong></li><li>User time: <strong>0m:15s</strong></li><li>Total time: <strong>2m:14s</strong></li><li>Page faults: <strong>5494</strong></li></ul></div><p>Here most of the stuff, including the <code>Cycles</code> doesn't interest us much, since we already know that from the timing. While these aren't very accurate (since there could have been a small difference when the application has been running beyond the life time of the test), it isn't in anyway going to skew our results. Evidently, WinApi has been highly efficient. But why? Look at the <code>Page faults</code>. Its a mere 5.5k as opposed to the 1 million 120 thousand that happened with windows forms. That should give a clue. By using the stack for almost everything, leaving the GC entirely for your application, <code>WinApi takes the C#/.NET Win32 desktop applications right into the C++ performance arena</code>.</p><h2>What WinApi.Windows doesn't do</h2><p>While you can do everything right on top WinApi, you'll have to do the layout, and control subclassing all by yourself. Actually, that's only major feature set that's missing from <code>WinApi</code>, that WinForms can do.</p><p>Providing a set of base interfaces, and base classes, even in parity with WinForms's <code>IControl</code> shouldn't be too time consuming. However, the reason I haven't written them is I have no intent to even try to provide a replacement for <code>WinForms</code>, which already does what its designed to do quite well. My intent with this project is not a GUI library, but rather a lean, light and efficient native interop layer.</p><p>If you want to build your own modern toolkit with technologies like <code>Direct2D</code>, <code>Skia</code>, etc, this should serve as the perfect foundation on Windows, and a low level way to interact with the OS.</p><p><code>WinApi.Windows.Controls</code> provides some basic controls like <code>Button</code>, <code>Edit</code> and <code>Static</code> - but its more of a sample library on how to write GDI based controls at this stage, than an actual usable library. Today, we tend to build using the more modern libraries like <code>Direct2D</code> and <code>Skia</code> (WPF, and Windows Runtime XAML for example, both sit on top of DirectX) - not the aged GDI.</p></article></main><footer class="mt-4"><hr><aside class="my-3"><p><a href="https://www.twitter.com/prasannavl">@prasannavl</a> - If you enjoyed this post, please <a href="https://twitter.com/intent/tweet?url=https://www.prasannavl.com/2016/10/introducing-winapi-comparing-gc-pressure-and-performance-with-winforms/" target="_blank">share it with your followers</a>.</p></aside><hr><nav class="clearfix footer-nav"><ul class="float-left list-inline"><li class="list-inline-item"><a href="javascript:window.scroll(0,0)">Top</a></li><li class="list-inline-item"><a href="/">Home</a></li><li class="list-inline-item"><a href="/archives/">Archives</a></li></ul></nav><p class="small text-muted mb-0 mt-1"><strong>Copyright © 2020 <a href="/">Prasanna Loganathar</a></strong>. Blog content, design elements or any information without a direct or indirect license is licensed under <a href="https://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons CC BY 4.0</a>. Similarly, any such code fragments are licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0" rel="license">Apache 2.0 License</a>.</p></footer></div></div></div></div><div id="nprogress" style="transition:all .4s linear 0s;opacity:0"><div class="bar" role="bar" style="transform:translate3d(0,0,0);transition:all .4s ease 0s"><div class="peg"></div></div><div class="spinner" role="spinner"><div class="spinner-icon"></div></div></div></body></html>