<!DOCTYPE html><html class="" lang="en"><head><meta charset="utf-8"><meta content="ie=edge" http-equiv="x-ua-compatible"><link href="/css/index.8abdea1f0a4fab97fb2a612d0a6c8fe1.css" rel="stylesheet"><script defer src="/js/runtime.e8b300f0556ed5d0c4aa.js" type="text/javascript"></script><script defer src="/js/vendor.2214c7d88e9dd54634d1.js" type="text/javascript"></script><script defer src="/js/index.e332e09cc7e67f046901.js" type="text/javascript"></script><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MZ2DHR');</script><!-- End Google Tag Manager --><script defer src="/js/chunks/common-index.9d929302abc5499a1dd6.js" type="text/javascript" charset="utf-8"></script><script defer src="/js/chunks/a5ae7a142a6a014e9666ff32d94329e4.26f0984240dd154a5b3e.js" type="text/javascript" charset="utf-8"></script><script defer src="/js/chunks/fd386dadc1cf9935e5882fcfbf40fb5d.414378448a6a68d300e3.js" type="text/javascript" charset="utf-8"></script><title>Introducing WinApi: Graphics with Direct3D, D2D1, GDI, OpenGL and Skia | Prasanna Loganathar</title><link href="/icons/favicon-32x32.png" rel="icon" data-react-helmet="true" sizes="32x32" type="image/png"><link href="/icons/favicon-96x96.png" rel="icon" data-react-helmet="true" sizes="96x96" type="image/png"><link href="/icons/favicon-16x16.png" rel="icon" data-react-helmet="true" sizes="16x16" type="image/png"><link href="/favicon.ico" rel="shortcut icon" data-react-helmet="true" type="image/x-icon"><link href="/icons/apple-touch-icon-57x57.png" rel="apple-touch-icon" data-react-helmet="true" sizes="57x57"><link href="/icons/apple-touch-icon-60x60.png" rel="apple-touch-icon" data-react-helmet="true" sizes="60x60"><link href="/icons/apple-touch-icon-72x72.png" rel="apple-touch-icon" data-react-helmet="true" sizes="72x72"><link href="/icons/apple-touch-icon-76x76.png" rel="apple-touch-icon" data-react-helmet="true" sizes="76x76"><link href="/icons/apple-touch-icon-114x114.png" rel="apple-touch-icon" data-react-helmet="true" sizes="114x114"><link href="/icons/apple-touch-icon-120x120.png" rel="apple-touch-icon" data-react-helmet="true" sizes="120x120"><link href="/icons/apple-touch-icon-144x144.png" rel="apple-touch-icon" data-react-helmet="true" sizes="144x144"><link href="/icons/apple-touch-icon-152x152.png" rel="apple-touch-icon" data-react-helmet="true" sizes="152x152"><link href="/icons/apple-touch-icon-180x180.png" rel="apple-touch-icon" data-react-helmet="true" sizes="180x180"><link href="/icons/safari-pinned-tab.svg" rel="mask-icon" data-react-helmet="true" color="#0096d6"><link href="/manifest.json" rel="manifest" data-react-helmet="true"><link href="https://www.prasannavl.com/rss.xml" rel="alternate" data-react-helmet="true" type="application/rss+xml"><link href="https://www.prasannavl.com/sitemap.xml" rel="sitemap" data-react-helmet="true"><meta content="Prasanna Loganathar's Weblog" data-react-helmet="true" name="description"><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" data-react-helmet="true" name="viewport"><meta content="#0096d6" data-react-helmet="true" name="msapplication-TileColor"><meta content="/icons/mstile-144x144.png" data-react-helmet="true" name="msapplication-TileImage"><meta content="/browserconfig.xml" data-react-helmet="true" name="msapplication-config"><meta content="summary" data-react-helmet="true" name="twitter:card"><meta content="@prasannavl" data-react-helmet="true" name="twitter:site"><meta content="@prasannavl" data-react-helmet="true" name="twitter:creator"><meta content="Introducing WinApi: Graphics with Direct3D, D2D1, GDI, OpenGL and Skia" data-react-helmet="true" name="twitter:title"><meta content="Article on WinApi - Part 3" data-react-helmet="true" name="twitter:description"><meta content="Introducing WinApi: Graphics with Direct3D, D2D1, GDI, OpenGL and Skia" data-react-helmet="true" property="og:title"><meta content="Prasanna Loganathar" data-react-helmet="true" property="og:site_name"><meta content="article" data-react-helmet="true" property="og:type"><meta content="Article on WinApi - Part 3" data-react-helmet="true" property="og:description"><meta content="https://www.prasannavl.com//icons/mstile-310x310.png" data-react-helmet="true" property="og:image"><meta content="http://localhost:45678/2016/10/introducing-winapi-graphics-with-direct3d-d2d1-gdi-opengl-and-skia/" data-react-helmet="true" property="og:url"><meta content="Prasanna Loganathar" data-react-helmet="true" property="og:article:author"><meta content="2016-10-23T19:42:37.156Z" data-react-helmet="true" property="og:article:article:published_time"></head><body><!-- Google Tag Manager (noscript) --><noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-MZ2DHR" style="display:none;visibility:hidden" width="0"></iframe></noscript><!-- End Google Tag Manager (noscript) --><div id="root"><div class="app-container container-fluid"><div class="row"><div class="col col-md-8 offset-md-2"><header class="banner"><h1 id="top"><a href="/">Prasanna Loganathar</a></h1><p>Explore more of <a href="/">my blog</a>, <a href="/archives/">archives</a> or subscribe to my <a href="/rss.xml" rel="alternate" type="application/rss+xml">feed</a>.</p><hr></header><main role="main"><article><header class="mb-4"><h1 class="title" rel="title">Introducing WinApi: Graphics with Direct3D, D2D1, GDI, OpenGL and Skia</h1><p class="d-none" rel="author">Prasanna Loganathar</p><p class="small text-muted" rel="date"><time datetime="2016-10-23T19:42:37.156Z">Sunday, 23rd Oct 2016</time></p></header><p><b>GitHub: </b><a href="https://github.com/prasannavl/WinApi">WinApi</a></p><p>As I introduced the basics of <a href="https://github.com/prasannavl/WinApi">WinApi</a> in my <a href="/2016/10/introducing-winapi-basics/">previous articles</a>, it may make sense to actually present something on the screen. And how better to do it, than by using the lowest-level of software drawing layers.</p><p><img alt="[Image]" class="img-fluid" src="/img/gfx-expose.5a699c0f8df1fc006273ee8bad4256e3.jpg"></p><p>Actually, the title probably includes every major drawing library other than <code>Cairo</code>, but I choose <code>Skia</code> for the purposes of demonstration here, since its at the crux of both <em>Google Chrome</em> and <em>Firefox</em>. It may seem overwhelming that I'm demoing all of these technologies in a single article, but this is where the helpers of <code>WinApi</code> gives a hand to make all this super easy, without compromising on the performance.</p><h2>The GDI Window</h2><p>Let's start with the most fundamental and built-in 2D graphics library with Windows - GDI.</p><pre><code><span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> factory <span class="token operator">=</span> WindowFactory<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>
            hBgBrush<span class="token punctuation">:</span> Gdi32Helpers<span class="token punctuation">.</span><span class="token function">GetStockObject</span><span class="token punctuation">(</span>StockObject<span class="token punctuation">.</span>WHITE_BRUSH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> win <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">CreateWindow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">MainWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"Hello"</span><span class="token punctuation">,</span> constructionParams<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">FrameWindowConstructionParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            win<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainWindow</span> <span class="token punctuation">:</span> <span class="token class-name">Window</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnPaint</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">PaintPacket</span> packet<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">PaintStruct</span> ps<span class="token punctuation">;</span>
        <span class="token keyword">var</span> hdc <span class="token operator">=</span> <span class="token function">BeginPaint</span><span class="token punctuation">(</span><span class="token keyword">out</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> rect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rectangle</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        RectangleHelpers<span class="token punctuation">.</span><span class="token function">Translate</span><span class="token punctuation">(</span><span class="token keyword">ref</span> rect<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> brush <span class="token operator">=</span> Gdi32Helpers<span class="token punctuation">.</span><span class="token function">CreateSolidBrush</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">130</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        User32Methods<span class="token punctuation">.</span><span class="token function">FillRect</span><span class="token punctuation">(</span>hdc<span class="token punctuation">,</span> <span class="token keyword">ref</span> rect<span class="token punctuation">,</span> brush<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Gdi32Methods<span class="token punctuation">.</span><span class="token function">DeleteObject</span><span class="token punctuation">(</span>brush<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">EndPaint</span><span class="token punctuation">(</span><span class="token keyword">ref</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnPaint</span><span class="token punctuation">(</span><span class="token keyword">ref</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>This should be straight-forward. I'm using <code>WindowFactory</code> here to register a new class, which has a background brush which is white. If not, it would end up with the default window brush, which is the windows mild gray, that you generally see. This can also be set to <code>IntPtr.Zero</code> (basically null), and take care of the erasing either in with the <code>OnEraseBkgnd</code>, or by directly handling the erase during paint method as well (which I'll do later for the DirectX samples).</p><p>So, this should look open up this window:</p><p><img alt="[Image]" class="img-fluid" src="/img/gfx-gdi.7658bf2033d73b470348ca9b69ba51cf.jpg"></p><p>That's about it. Nothing special to be done here, and all the Gdi methods can be used as usual.</p><h2>The Skia Window</h2><p>I'm going to skip right off to using <code>Skia</code> next. The best way to use Skia from C# is by using the <code>SkiaSharp</code> library from the Xamarin team.</p><p>While using Skia, you have complete control over how and when you allocate the memory for your window bitmap. I prefer to allocate native memory, and pass the pointers directly to Skia. And in order to ease this, I've already written a <code>NativePixelBuffer</code> class into <code>WinApi.Utils</code>, that automatically manages the pixel buffer for a given size, and resizes the native memory as required. It should take care of the buffer length, and image stride (currently only supports 32-bit Rgba, which should be sufficient for most purposes).</p><p>With all that out of the way, I'm going to start off with a paint handler given a <code>SKSurface</code>.</p><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SkiaPainter</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ProcessPaint</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">PaintPacket</span> packet<span class="token punctuation">,</span> <span class="token class-name">NativePixelBuffer</span> pixelBuffer<span class="token punctuation">,</span>
        Action<span class="token operator">&lt;</span>SKSurface<span class="token operator">></span> handler<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> hwnd <span class="token operator">=</span> packet<span class="token punctuation">.</span>Hwnd<span class="token punctuation">;</span>
        <span class="token class-name">Rectangle</span> clientRect<span class="token punctuation">;</span>
        User32Methods<span class="token punctuation">.</span><span class="token function">GetClientRect</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> <span class="token keyword">out</span> clientRect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> size <span class="token operator">=</span> clientRect<span class="token punctuation">.</span><span class="token function">GetSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pixelBuffer<span class="token punctuation">.</span><span class="token function">EnsureSize</span><span class="token punctuation">(</span>size<span class="token punctuation">.</span>Width<span class="token punctuation">,</span> size<span class="token punctuation">.</span>Height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PaintStruct</span> ps<span class="token punctuation">;</span>
        <span class="token keyword">var</span> hdc <span class="token operator">=</span> User32Methods<span class="token punctuation">.</span><span class="token function">BeginPaint</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> <span class="token keyword">out</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> skPainted <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> surface <span class="token operator">=</span> SKSurface<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>
                size<span class="token punctuation">.</span>Width<span class="token punctuation">,</span>
                size<span class="token punctuation">.</span>Height<span class="token punctuation">,</span>
                SKColorType<span class="token punctuation">.</span>Bgra8888<span class="token punctuation">,</span>
                SKAlphaType<span class="token punctuation">.</span>Premul<span class="token punctuation">,</span>
                pixelBuffer<span class="token punctuation">.</span>Handle<span class="token punctuation">,</span>
                pixelBuffer<span class="token punctuation">.</span>Stride<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>surface <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token function">handler</span><span class="token punctuation">(</span>surface<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    skPainted <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">finally</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>skPainted<span class="token punctuation">)</span> Gdi32Helpers<span class="token punctuation">.</span><span class="token function">SetRgbBitsToDevice</span><span class="token punctuation">(</span>
                hdc<span class="token punctuation">,</span> size<span class="token punctuation">.</span>Width<span class="token punctuation">,</span> size<span class="token punctuation">.</span>Height<span class="token punctuation">,</span> pixelBuffer<span class="token punctuation">.</span>Handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            User32Methods<span class="token punctuation">.</span><span class="token function">EndPaint</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> <span class="token keyword">ref</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Looks simple enough. It simply creates a surface, and calls in a delegate that does all the painting. <strong>This can technically be optimized further by pooling, or caching the <code>SKSurface</code>, but I'm going to skip it for now</strong>.</p><p>The interesting method here is the <code>Gdi32Helpers.SetRgbBitsToDevice</code>. Its simply a helper for <code>SetDIBitsToDevice</code> GDI method, that takes care of the bitmap header parameters, and blitting the surface over.</p><p>Now, I can encapsulate a window that uses this:</p><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SkiaWindowBase</span> <span class="token punctuation">:</span> <span class="token class-name">EventedWindowCore</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">NativePixelBuffer</span> m_pixelBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativePixelBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">OnSkiaPaint</span><span class="token punctuation">(</span><span class="token class-name">SKSurface</span> surface<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnPaint</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">PaintPacket</span> packet<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        SkiaPainter<span class="token punctuation">.</span><span class="token function">ProcessPaint</span><span class="token punctuation">(</span><span class="token keyword">ref</span> packet<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>m_pixelBuffer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>OnSkiaPaint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token keyword">bool</span> disposing<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>m_pixelBuffer<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span>disposing<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Yup. That's about it. You can now go ahead and use Skia to handle all the painting.</p><pre><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
        ApplicationHelpers<span class="token punctuation">.</span><span class="token function">SetupDefaultExceptionHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> factory <span class="token operator">=</span> WindowFactory<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>hBgBrush<span class="token punctuation">:</span> IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> win <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">CreateWindow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">SkiaWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Hello"</span><span class="token punctuation">,</span>
            constructionParams<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">FrameWindowConstructionParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            win<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        MessageBoxHelpers<span class="token punctuation">.</span><span class="token function">ShowError</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">SkiaWindow</span> <span class="token punctuation">:</span> <span class="token class-name">SkiaWindowBase</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnSkiaPaint</span><span class="token punctuation">(</span><span class="token class-name">SKSurface</span> surface<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> windowRect <span class="token operator">=</span> <span class="token function">GetWindowRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> clientRect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rectangle</span><span class="token punctuation">(</span>windowRect<span class="token punctuation">.</span>Width<span class="token punctuation">,</span> windowRect<span class="token punctuation">.</span>Height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> canvas <span class="token operator">=</span> surface<span class="token punctuation">.</span>Canvas<span class="token punctuation">;</span>
        canvas<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SKColor</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> textPainter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SKPaint</span> <span class="token punctuation">{</span>TextSize <span class="token operator">=</span> <span class="token number">35</span><span class="token punctuation">,</span> IsAntialias <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">"Hello there!"</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> textBounds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SKRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> m <span class="token operator">=</span> textPainter<span class="token punctuation">.</span><span class="token function">MeasureText</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token keyword">ref</span> textBounds<span class="token punctuation">)</span><span class="token punctuation">;</span>

        canvas<span class="token punctuation">.</span><span class="token function">DrawText</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token punctuation">(</span>clientRect<span class="token punctuation">.</span>Width <span class="token operator">-</span> textBounds<span class="token punctuation">.</span>Width<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> 
            <span class="token punctuation">(</span>clientRect<span class="token punctuation">.</span>Height <span class="token operator">-</span> textBounds<span class="token punctuation">.</span>Height<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span>
            textPainter<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnSkiaPaint</span><span class="token punctuation">(</span>surface<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>And the result:</p><p><img alt="[Image]" class="img-fluid" src="/img/gfx-skia.71ce032ca1fb4b3715c2a1da3282606c.jpg"></p><h2>The OpenGL Window</h2><p>Moving on to OpenGL, I'm going to use <code>OpenGL.Net</code> as a raw wrapper to OpenGL. However, I'm going to leave the initialization of GL out of the sample here, since its quite complicated. I've already written a class <code>OpenGlWindow</code> that wraps over all of that in the sample that's already there in the <code>WinApi</code> repo:</p><p><a href="https://github.com/prasannavl/WinApi/tree/master/Samples/Sample.OpenGL">https://github.com/prasannavl/WinApi/tree/master/Samples/Sample.OpenGL</a></p><p>Reusing the class from there:</p><pre><code><span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            ApplicationHelpers<span class="token punctuation">.</span><span class="token function">SetupDefaultExceptionHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Gl<span class="token punctuation">.</span><span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> factory <span class="token operator">=</span> WindowFactory<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>hBgBrush<span class="token punctuation">:</span> 
                Gdi32Helpers<span class="token punctuation">.</span><span class="token function">GetStockObject</span><span class="token punctuation">(</span>StockObject<span class="token punctuation">.</span>BLACK_BRUSH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> win <span class="token operator">=</span> Window<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Create</span><span class="token punctuation">&lt;</span><span class="token class-name">AppWindow</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>factory<span class="token punctuation">:</span> factory<span class="token punctuation">,</span>
                    text<span class="token punctuation">:</span> <span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                win<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            MessageBoxHelpers<span class="token punctuation">.</span><span class="token function">ShowError</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">AppWindow</span> <span class="token punctuation">:</span> <span class="token class-name">OpenGlWindow</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnGlContextCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Gl<span class="token punctuation">.</span><span class="token function">MatrixMode</span><span class="token punctuation">(</span>MatrixMode<span class="token punctuation">.</span>Projection<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Gl<span class="token punctuation">.</span><span class="token function">LoadIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Gl<span class="token punctuation">.</span><span class="token function">Ortho</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Gl<span class="token punctuation">.</span><span class="token function">MatrixMode</span><span class="token punctuation">(</span>MatrixMode<span class="token punctuation">.</span>Modelview<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Gl<span class="token punctuation">.</span><span class="token function">LoadIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnGlContextCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnGlPaint</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">PaintStruct</span> ps<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Gl<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span>ClearBufferMask<span class="token punctuation">.</span>ColorBufferBit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token function">GetClientSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Gl<span class="token punctuation">.</span><span class="token function">Viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> size<span class="token punctuation">.</span>Width<span class="token punctuation">,</span> size<span class="token punctuation">.</span>Height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Gl<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span>PrimitiveType<span class="token punctuation">.</span>Triangles<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Gl<span class="token punctuation">.</span><span class="token function">Color3</span><span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Gl<span class="token punctuation">.</span><span class="token function">Vertex2</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Gl<span class="token punctuation">.</span><span class="token function">Color3</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Gl<span class="token punctuation">.</span><span class="token function">Vertex2</span><span class="token punctuation">(</span><span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Gl<span class="token punctuation">.</span><span class="token function">Color3</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Gl<span class="token punctuation">.</span><span class="token function">Vertex2</span><span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Gl<span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        DeviceContext<span class="token punctuation">.</span><span class="token function">SwapBuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>And here's the result:</p><p><img alt="[Image]" class="img-fluid" src="/img/gfx-opengl.03f435c7c65f8da7684edc5d44bfc54d.jpg"></p><h2>The Direct3D and Direct2D Window</h2><p>And finally to DirectX. I kept this for the last, because its generally considered to the most complex of it all - It requires in-depth knowledge of how the GPU pipeline actually works, swap chains, color formats and life-cycle management of the GPU meta resources, and a lot more. However, with <code>WinApi.DxUtils</code>, you don't have do any of that.</p><p>And with DirectX, I also decided to up the game a little, even for the quick sample. If you look closely into the screenshot in the beginning of the article, there's <strong>a window that has per-pixel alpha with varying opacity blending beautifully into the desktop</strong>. Doing this the high-performance way requires you use <code>DirectComposition</code> in all its glory. Well, thanks to <code>WinApi.DxUtils</code>, all of that is already taken care of, again.</p><p>First off, I'm going to create a window with <code>WS_EX_NOREDIRECTIONBITMAP</code> style. This works on Win 8+, designed specially for high-performance compositing to direct DWM to not allocate a redirection bitmap - The DXGI surface is shared with DWM directly on the GPU, making per-pixel alpha compositing super-performant. Internally, this is one of the things, all the modern Windows Runtime apps use, by default.</p><pre><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
        ApplicationHelpers<span class="token punctuation">.</span><span class="token function">SetupDefaultExceptionHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> factory <span class="token operator">=</span> WindowFactory<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>hBgBrush<span class="token punctuation">:</span> IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span>
            <span class="token keyword">var</span> win <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">CreateWindow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">MainWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Hello"</span><span class="token punctuation">,</span>
                constructionParams<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">FrameWindowConstructionParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                exStyles<span class="token punctuation">:</span> WindowExStyles<span class="token punctuation">.</span>WS_EX_APPWINDOW
                    <span class="token operator">|</span> WindowExStyles<span class="token punctuation">.</span>WS_EX_NOREDIRECTIONBITMAP<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            win<span class="token punctuation">.</span><span class="token function">CenterToScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            win<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        MessageBoxHelpers<span class="token punctuation">.</span><span class="token function">ShowError</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>This ends up with a window without no surface at all, and just the non-client frames. And then, I'm going to use the <code>Dx11Component</code> for <code>WinApi.DxUtils</code>. This is <strong>a meta-resource manager that manages all of DXGI, D3D11, D2D1, DirectWrite, and DirectComposition</strong>.</p><p>The really cool thing about the <code>Dx11Component</code> is that it conjures up the latest and greatest <code>Dx11</code> resource set that your platform can support. If you're on Window 7, it skips DirectComposition. Windows 8 also uses a slightly different codepath than Windows 8.1 and 10. All of these are handled seamlessly by DxUtils. I initially had written it with support for DXGI 1, but I decided to scrap it and use DXGI 1.2 as the lowest, simply to keep it baggage free. All the interfaces are still present, but it just doesn't provide default implementations for DXGI versions less than 1.2.</p><p>So, in all its glory, the entire management of D3D11, D2D1, DirectWrite and DComp which can usually takes up a lot of code, now simply translates into:</p><pre><code><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">DxWindow</span> <span class="token punctuation">:</span> <span class="token class-name">EventedWindowCore</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Dx11Component</span> m_dx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dx11Component</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnCreate</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">CreateWindowPacket</span> packet<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Dx<span class="token punctuation">.</span><span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Handle<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">GetClientSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnCreate</span><span class="token punctuation">(</span><span class="token keyword">ref</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">OnDxDraw</span><span class="token punctuation">(</span><span class="token class-name">Dx11Component</span> dx<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnPaint</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">PaintPacket</span> packet<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        m_dx<span class="token punctuation">.</span><span class="token function">EnsureInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            <span class="token function">OnDxDraw</span><span class="token punctuation">(</span>m_dx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">Validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SharpDXException</span> ex<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_dx<span class="token punctuation">.</span><span class="token function">PerformResetOnException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnSize</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">SizePacket</span> packet<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Dx<span class="token punctuation">.</span><span class="token function">Resize</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span>Size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnSize</span><span class="token punctuation">(</span><span class="token keyword">ref</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token keyword">bool</span> disposing<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        m_dx<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span>disposing<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Yup! That's all there is to it.</p><p>But.. I just lied - <strong>you don't even have to write this</strong>!</p><p>I showed this just so that you can. This gives you complete control over the creation, and configurations of the swapchain, formats and so on while creating the <code>Dx11Component</code>. However, for simpler scenarios, <code>DxUtils</code> already includes a <code>DxWindow</code>, that does all of this.</p><p>So, all you need to do, is derive from <code>DxWindow</code>:</p><pre><code><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">MainWindow</span> <span class="token punctuation">:</span> <span class="token class-name">DxWindow</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnDxPaint</span><span class="token punctuation">(</span><span class="token class-name">Dx11Component</span> resource<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> rand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token function">GetClientSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> w <span class="token operator">=</span> size<span class="token punctuation">.</span>Width<span class="token punctuation">;</span>
        <span class="token keyword">var</span> h <span class="token operator">=</span> size<span class="token punctuation">.</span>Height<span class="token punctuation">;</span>
        <span class="token keyword">var</span> context <span class="token operator">=</span> resource<span class="token punctuation">.</span>D2D<span class="token punctuation">.</span>Context<span class="token punctuation">;</span>

        context<span class="token punctuation">.</span><span class="token function">BeginDraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RawColor4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SolidColorBrush</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">RawColor4</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">NextFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rand<span class="token punctuation">.</span><span class="token function">NextFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rand<span class="token punctuation">.</span><span class="token function">NextFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.4f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        context<span class="token punctuation">.</span><span class="token function">FillRectangle</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RawRectangleF</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">700</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            b<span class="token punctuation">.</span>Color <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RawColor4</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">NextFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rand<span class="token punctuation">.</span><span class="token function">NextFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                rand<span class="token punctuation">.</span><span class="token function">NextFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.4f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span><span class="token function">FillEllipse</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">Ellipse</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RawVector2</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">NextFloat</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                    rand<span class="token punctuation">.</span><span class="token function">NextFloat</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rand<span class="token punctuation">.</span><span class="token function">NextFloat</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    rand<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span><span class="token function">FillRectangle</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">RawRectangleF</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">NextFloat</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                    rand<span class="token punctuation">.</span><span class="token function">NextFloat</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> rand<span class="token punctuation">.</span><span class="token function">NextFloat</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    rand<span class="token punctuation">.</span><span class="token function">NextFloat</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        b<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">EndDraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>As far as I know, this is probably the quickest way that exists to date, to start off reliable DirectX applications, and all of this with no compromise on the performance in anyway. Unless you come across errors or device loss (handling of which are also fully automatic, btw) there's really no GC allocation on the painting path, and it provides you nothing but raw performance.</p><p>And the result:</p><p><img alt="[Image]" class="img-fluid" src="/img/gfx-dx.f0e806a0b6024095076aeb10a6e3f429.jpg"></p></article></main><footer class="mt-4"><hr><aside class="my-3"><p><a href="https://www.twitter.com/prasannavl">@prasannavl</a> - If you enjoyed this post, please <a href="https://twitter.com/intent/tweet?url=https://www.prasannavl.com/2016/10/introducing-winapi-graphics-with-direct3d-d2d1-gdi-opengl-and-skia/" target="_blank">share it with your followers</a>.</p></aside><hr><nav class="clearfix footer-nav"><ul class="float-left list-inline"><li class="list-inline-item"><a href="javascript:window.scroll(0,0)">Top</a></li><li class="list-inline-item"><a href="/">Home</a></li><li class="list-inline-item"><a href="/archives/">Archives</a></li></ul></nav><p class="small text-muted mb-0 mt-1"><strong>Copyright  2020 <a href="/">Prasanna Loganathar</a></strong>. Blog content, design elements or any information without a direct or indirect license is licensed under <a href="https://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons CC BY 4.0</a>. Similarly, any such code fragments are licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0" rel="license">Apache 2.0 License</a>.</p></footer></div></div></div></div></body></html>