<!DOCTYPE html><html class="nprogress-busy" lang="en"><head><meta charset="utf-8"><meta content="ie=edge" http-equiv="x-ua-compatible"><link href="/css/index.8abdea1f0a4fab97fb2a612d0a6c8fe1.css" rel="stylesheet"><script defer src="/js/runtime.e8b300f0556ed5d0c4aa.js" type="text/javascript"></script><script defer src="/js/vendor.2214c7d88e9dd54634d1.js" type="text/javascript"></script><script defer src="/js/index.e332e09cc7e67f046901.js" type="text/javascript"></script><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MZ2DHR');</script><!-- End Google Tag Manager --><script defer src="/js/chunks/common-index.9d929302abc5499a1dd6.js" type="text/javascript" charset="utf-8"></script><script defer src="/js/chunks/9c342dd06dc4856b348f078fbbe72434.48639b69cf29df9eef60.js" type="text/javascript" charset="utf-8"></script><script defer src="/js/chunks/fd386dadc1cf9935e5882fcfbf40fb5d.414378448a6a68d300e3.js" type="text/javascript" charset="utf-8"></script><title>Introducing WinApi: Basics | Prasanna Loganathar</title><link href="/icons/favicon-32x32.png" rel="icon" data-react-helmet="true" sizes="32x32" type="image/png"><link href="/icons/favicon-96x96.png" rel="icon" data-react-helmet="true" sizes="96x96" type="image/png"><link href="/icons/favicon-16x16.png" rel="icon" data-react-helmet="true" sizes="16x16" type="image/png"><link href="/favicon.ico" rel="shortcut icon" data-react-helmet="true" type="image/x-icon"><link href="/icons/apple-touch-icon-57x57.png" rel="apple-touch-icon" data-react-helmet="true" sizes="57x57"><link href="/icons/apple-touch-icon-60x60.png" rel="apple-touch-icon" data-react-helmet="true" sizes="60x60"><link href="/icons/apple-touch-icon-72x72.png" rel="apple-touch-icon" data-react-helmet="true" sizes="72x72"><link href="/icons/apple-touch-icon-76x76.png" rel="apple-touch-icon" data-react-helmet="true" sizes="76x76"><link href="/icons/apple-touch-icon-114x114.png" rel="apple-touch-icon" data-react-helmet="true" sizes="114x114"><link href="/icons/apple-touch-icon-120x120.png" rel="apple-touch-icon" data-react-helmet="true" sizes="120x120"><link href="/icons/apple-touch-icon-144x144.png" rel="apple-touch-icon" data-react-helmet="true" sizes="144x144"><link href="/icons/apple-touch-icon-152x152.png" rel="apple-touch-icon" data-react-helmet="true" sizes="152x152"><link href="/icons/apple-touch-icon-180x180.png" rel="apple-touch-icon" data-react-helmet="true" sizes="180x180"><link href="/icons/safari-pinned-tab.svg" rel="mask-icon" data-react-helmet="true" color="#0096d6"><link href="/manifest.json" rel="manifest" data-react-helmet="true"><link href="https://www.prasannavl.com/rss.xml" rel="alternate" data-react-helmet="true" type="application/rss+xml"><link href="https://www.prasannavl.com/sitemap.xml" rel="sitemap" data-react-helmet="true"><meta content="Prasanna Loganathar's Weblog" data-react-helmet="true" name="description"><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" data-react-helmet="true" name="viewport"><meta content="#0096d6" data-react-helmet="true" name="msapplication-TileColor"><meta content="/icons/mstile-144x144.png" data-react-helmet="true" name="msapplication-TileImage"><meta content="/browserconfig.xml" data-react-helmet="true" name="msapplication-config"><meta content="summary" data-react-helmet="true" name="twitter:card"><meta content="@prasannavl" data-react-helmet="true" name="twitter:site"><meta content="@prasannavl" data-react-helmet="true" name="twitter:creator"><meta content="Introducing WinApi: Basics" data-react-helmet="true" name="twitter:title"><meta content="Article on WinApi - Part 2" data-react-helmet="true" name="twitter:description"><meta content="Introducing WinApi: Basics" data-react-helmet="true" property="og:title"><meta content="Prasanna Loganathar" data-react-helmet="true" property="og:site_name"><meta content="article" data-react-helmet="true" property="og:type"><meta content="Article on WinApi - Part 2" data-react-helmet="true" property="og:description"><meta content="https://www.prasannavl.com//icons/mstile-310x310.png" data-react-helmet="true" property="og:image"><meta content="http://localhost:45678/2016/10/introducing-winapi-basics/" data-react-helmet="true" property="og:url"><meta content="Prasanna Loganathar" data-react-helmet="true" property="og:article:author"><meta content="2016-10-22T14:01:11.533Z" data-react-helmet="true" property="og:article:article:published_time"></head><body><!-- Google Tag Manager (noscript) --><noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-MZ2DHR" style="display:none;visibility:hidden" width="0"></iframe></noscript><!-- End Google Tag Manager (noscript) --><div id="root"><div class="app-container container-fluid"><div class="row"><div class="col col-md-8 offset-md-2"><header class="banner"><h1 id="top"><a href="/">Prasanna Loganathar</a></h1><p>Explore more of <a href="/">my blog</a>, <a href="/archives/">archives</a> or subscribe to my <a href="/rss.xml" rel="alternate" type="application/rss+xml">feed</a>.</p><hr></header><main role="main"><article><header class="mb-4"><h1 class="title" rel="title">Introducing WinApi: Basics</h1><p class="d-none" rel="author">Prasanna Loganathar</p><p class="small text-muted" rel="date"><time datetime="2016-10-22T14:01:11.533Z">Saturday, 22nd Oct 2016</time></p></header><p><b>GitHub: </b><a href="https://github.com/prasannavl/WinApi">WinApi</a></p><p>In the previous article <a href="/2016/10/introducing-winapi-the-evolution/">here</a>, I discussed the evolution of programs that use the Windows API with C/C++ and C# snippets, and it ultimately ended out with this C# snippet:</p><pre><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> win <span class="token operator">=</span> Window<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>text<span class="token punctuation">:</span> <span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        win<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Yup. That's fully functional code that works. Just add references to <code>WinApi</code>, and <code>WinApi.Controls</code> which are both <code>less than 150kb</code> combined, and it'll do what its excepted to do. However, before I get into samples that look nifty, let's look at a precise translation of the C/C++ program in the previous article, without the use of the <code>Window</code> abstraction that <code>WinApi</code> provides in the helper namespace <code>WinApi.Windows</code>.</p><p>A very raw program that uses the Windows API would look like this:</p><pre><code><span class="token keyword">using</span> System<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">;</span>
<span class="token keyword">using</span> WinApi<span class="token punctuation">.</span>Gdi32<span class="token punctuation">;</span>
<span class="token keyword">using</span> WinApi<span class="token punctuation">.</span>Kernel32<span class="token punctuation">;</span>
<span class="token keyword">using</span> WinApi<span class="token punctuation">.</span>User32<span class="token punctuation">;</span>

<span class="token keyword">namespace</span> Sample<span class="token punctuation">.</span>Win32
<span class="token punctuation">{</span>
    <span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">var</span> instanceHandle <span class="token operator">=</span> Kernel32Methods<span class="token punctuation">.</span><span class="token function">GetModuleHandle</span><span class="token punctuation">(</span>IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">var</span> wc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WindowClassEx</span>
            <span class="token punctuation">{</span>
                Size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">uint</span><span class="token punctuation">)</span> Marshal<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">SizeOf</span><span class="token punctuation">&lt;</span><span class="token class-name">WindowClassEx</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                ClassName <span class="token operator">=</span> <span class="token string">"MainWindow"</span><span class="token punctuation">,</span>
                CursorHandle <span class="token operator">=</span> User32Helpers<span class="token punctuation">.</span><span class="token function">LoadCursor</span><span class="token punctuation">(</span>IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">,</span> SystemCursor<span class="token punctuation">.</span>IDC_ARROW<span class="token punctuation">)</span><span class="token punctuation">,</span>
                IconHandle <span class="token operator">=</span> User32Helpers<span class="token punctuation">.</span><span class="token function">LoadIcon</span><span class="token punctuation">(</span>IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">,</span> SystemIcon<span class="token punctuation">.</span>IDI_APPLICATION<span class="token punctuation">)</span><span class="token punctuation">,</span>
                Styles <span class="token operator">=</span> WindowClassStyles<span class="token punctuation">.</span>CS_HREDRAW <span class="token operator">|</span> WindowClassStyles<span class="token punctuation">.</span>CS_VREDRAW<span class="token punctuation">,</span>
                BackgroundBrushHandle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntPtr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> StockObject<span class="token punctuation">.</span>WHITE_BRUSH<span class="token punctuation">)</span><span class="token punctuation">,</span>
                WindowProc <span class="token operator">=</span> WindowProc<span class="token punctuation">,</span>
                InstanceHandle <span class="token operator">=</span> instanceHandle
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token keyword">var</span> resReg <span class="token operator">=</span> User32Methods<span class="token punctuation">.</span><span class="token function">RegisterClassEx</span><span class="token punctuation">(</span><span class="token keyword">ref</span> wc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resReg <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                Console<span class="token punctuation">.</span>Error<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"registration failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">var</span> hwnd <span class="token operator">=</span> User32Methods<span class="token punctuation">.</span><span class="token function">CreateWindowEx</span><span class="token punctuation">(</span>WindowExStyles<span class="token punctuation">.</span>WS_EX_APPWINDOW<span class="token punctuation">,</span>
                wc<span class="token punctuation">.</span>ClassName<span class="token punctuation">,</span> <span class="token string">"Hello"</span><span class="token punctuation">,</span> WindowStyles<span class="token punctuation">.</span>WS_OVERLAPPEDWINDOW<span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> CreateWindowFlags<span class="token punctuation">.</span>CW_USEDEFAULT<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> CreateWindowFlags<span class="token punctuation">.</span>CW_USEDEFAULT<span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> CreateWindowFlags<span class="token punctuation">.</span>CW_USEDEFAULT<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> CreateWindowFlags<span class="token punctuation">.</span>CW_USEDEFAULT<span class="token punctuation">,</span>
                IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">,</span> IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">,</span> instanceHandle<span class="token punctuation">,</span> IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>hwnd <span class="token operator">==</span> IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                Console<span class="token punctuation">.</span>Error<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"window creation failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            User32Methods<span class="token punctuation">.</span><span class="token function">ShowWindow</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> ShowWindowCommands<span class="token punctuation">.</span>SW_SHOWNORMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
            User32Methods<span class="token punctuation">.</span><span class="token function">UpdateWindow</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Message</span> msg<span class="token punctuation">;</span>
            <span class="token keyword">int</span> res<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>res <span class="token operator">=</span> User32Methods<span class="token punctuation">.</span><span class="token function">GetMessage</span><span class="token punctuation">(</span><span class="token keyword">out</span> msg<span class="token punctuation">,</span> IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                User32Methods<span class="token punctuation">.</span><span class="token function">TranslateMessage</span><span class="token punctuation">(</span><span class="token keyword">ref</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                User32Methods<span class="token punctuation">.</span><span class="token function">DispatchMessage</span><span class="token punctuation">(</span><span class="token keyword">ref</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">IntPtr</span> <span class="token function">WindowProc</span><span class="token punctuation">(</span><span class="token class-name">IntPtr</span> hwnd<span class="token punctuation">,</span> <span class="token keyword">uint</span> umsg<span class="token punctuation">,</span>
            <span class="token class-name">IntPtr</span> wParam<span class="token punctuation">,</span> <span class="token class-name">IntPtr</span> lParam<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">var</span> msg <span class="token operator">=</span> <span class="token punctuation">(</span>WM<span class="token punctuation">)</span> umsg<span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">case</span> WM<span class="token punctuation">.</span>ERASEBKGND<span class="token punctuation">:</span>
                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IntPtr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> WM<span class="token punctuation">.</span>CLOSE<span class="token punctuation">:</span>
                <span class="token punctuation">{</span>
                    User32Methods<span class="token punctuation">.</span><span class="token function">PostQuitMessage</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> WM<span class="token punctuation">.</span>PAINT<span class="token punctuation">:</span>
                <span class="token punctuation">{</span>
                    <span class="token class-name">PaintStruct</span> ps<span class="token punctuation">;</span>
                    <span class="token keyword">var</span> hdc <span class="token operator">=</span> User32Methods<span class="token punctuation">.</span><span class="token function">BeginPaint</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> <span class="token keyword">out</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    User32Methods<span class="token punctuation">.</span><span class="token function">FillRect</span><span class="token punctuation">(</span>hdc<span class="token punctuation">,</span> <span class="token keyword">ref</span> ps<span class="token punctuation">.</span>PaintRect<span class="token punctuation">,</span>
                        Gdi32Helpers<span class="token punctuation">.</span><span class="token function">GetStockObject</span><span class="token punctuation">(</span>StockObject<span class="token punctuation">.</span>WHITE_BRUSH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    User32Methods<span class="token punctuation">.</span><span class="token function">EndPaint</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> <span class="token keyword">ref</span> ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> User32Methods<span class="token punctuation">.</span><span class="token function">DefWindowProc</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> umsg<span class="token punctuation">,</span> wParam<span class="token punctuation">,</span> lParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Why would one do this? Because you can. You have no reason to go this really tedious way, however - if you want you always can. The primary function of <code>WinApi</code> is after-all to provide a clean high-performance interop story.</p><p>It does exactly what the previous C/C++ programs did. There's no additional GC pressure, other than loading the CLR before the initialization of <code>Main</code> itself, <code>the JIT-compiled code would almost precisely match the assembly code of your C++</code>! Try doing that with Windows Forms. ;)</p><p>You can accomplish this in C# yourself, but you have to add all the ugly PInvokes, and method signatures aren't always straight-forward, and even sources like <code>pinvoke.net</code> aren't always correct and are riddled with subtle errors, all of which WinApi handles.</p><p>However, this program above is probably purely academic - not because it has to be, just because there better ways to do this using the <code>WinApi.Windows</code> namespace.</p><h2>WinApi structure</h2><p>Before getting to the <code>WinApi.Windows</code> namespace, I'd like to briefly touch on how <code>WinApi</code> is organized. Each library that corresponds to a <code>windows dll</code> gets its own namespace.</p><p>Examples, <code>kernel32.dll</code> functions all are in the <code>WinApi.Kernel32</code> namespace, <code>user32.dll</code> into <code>WinApi.User32</code> namespace, and so on.</p><p>And inside each namespace is a static class which ends with <code>Methods</code>. Ex: <code>User32Methods</code> - this class has all the functions of the user32.dll in its most primitive form. What this means is that, if a functions could potentially take multiple forms of input, say different structures, or variables enumerations - this method is the lower common factor, with the least marshalling performance impact.</p><p>As an example <code>User32Methods</code> has the following method defined:</p><pre><code><span class="token punctuation">[</span><span class="token class-name">DllImport</span><span class="token punctuation">(</span>LibraryName<span class="token punctuation">,</span> ExactSpelling <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">MapWindowPoints</span><span class="token punctuation">(</span><span class="token class-name">IntPtr</span> hWndFrom<span class="token punctuation">,</span> <span class="token class-name">IntPtr</span> hWndTo<span class="token punctuation">,</span> <span class="token class-name">IntPtr</span> lpPoints<span class="token punctuation">,</span> <span class="token keyword">int</span> cPoints<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>It takes all inputs in the form of <code>IntPtr</code>, which allows any kind of marshalling.</p><p>At the same time, <code>User32Helpers</code> has the following implementations:</p><pre><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token keyword">int</span> <span class="token function">MapWindowPoints</span><span class="token punctuation">(</span><span class="token class-name">IntPtr</span> hWndFrom<span class="token punctuation">,</span> <span class="token class-name">IntPtr</span> hWndTo<span class="token punctuation">,</span> <span class="token keyword">ref</span> <span class="token class-name">Point</span> point<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">fixed</span> <span class="token punctuation">(</span>Point<span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token operator">&</span>point<span class="token punctuation">)</span>
        <span class="token keyword">return</span> User32Methods<span class="token punctuation">.</span><span class="token function">MapWindowPoints</span><span class="token punctuation">(</span>hWndFrom<span class="token punctuation">,</span> hWndTo<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IntPtr</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
    
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token keyword">int</span> <span class="token function">MapWindowPoints</span><span class="token punctuation">(</span><span class="token class-name">IntPtr</span> hWndFrom<span class="token punctuation">,</span> <span class="token class-name">IntPtr</span> hWndTo<span class="token punctuation">,</span> <span class="token keyword">ref</span> <span class="token class-name">Rectangle</span> rect<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">fixed</span> <span class="token punctuation">(</span>Rectangle<span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token operator">&</span>rect<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> ptPtr <span class="token operator">=</span> <span class="token punctuation">(</span>Point<span class="token operator">*</span><span class="token punctuation">)</span> ptr<span class="token punctuation">;</span>
        <span class="token keyword">return</span> User32Methods<span class="token punctuation">.</span><span class="token function">MapWindowPoints</span><span class="token punctuation">(</span>hWndFrom<span class="token punctuation">,</span> hWndTo<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IntPtr</span><span class="token punctuation">(</span>ptPtr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Again, this provides straight forward Marshalling without any performance impact, since it simply pins the struct which already have C-Layouts, and passes in the pointers.</p><p>Similar concepts are followed throughout the library in the form of <code>Methods</code> and <code>Helpers</code> to provide both raw and safer signatures.</p><p>Then, there's also the <code>Experimental</code> namespace inside each of the library namespaces, that provide all the undocumented functions, and helpers.</p><h2><code>WinApi.Windows</code></h2><p>Then comes the one namespace that is special - This is not named after any native library. This library provides helpers into <code>Windows</code> - the literal windows that your applications use. It provides a high-performance, GC-allocation-free message loop, that's resembles ATL/WTL programming.</p><h3>Class: <code>NativeWindow</code></h3><p>This is the class that is the thinnest layer of Window. It simply wraps the original <code>Win32</code> handle. And it only has a single member - an IntPtr of <code>Handle</code>, and provides a way to attach itself to any Handle, and allows nice wrappers to be used through out.</p><pre><code><span class="token keyword">var</span> win <span class="token operator">=</span> WindowFactory<span class="token punctuation">.</span><span class="token function">CreateWindowFromHandle</span><span class="token punctuation">(</span>someHwnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
win<span class="token punctuation">.</span><span class="token function">SetText</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
win<span class="token punctuation">.</span><span class="token function">SetPosition</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
win<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
win<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3>Class: <code>WindowFactory</code></h3><p>This is the class that acts as a <code>WNDCLASSEX</code> registration manager for Win32. It registers a class, manages its lifetime, and creates Windows of that particular class.</p><p>It also provides all the convenience methods to be able to create classes as <code>NativeWindow</code>, or as any other derivative of <code>WindowCore</code>, and provides attachment, and connection implementations. It also has generic methods that are able to project the created class to any C# type that derives from <code>WindowCore</code>.</p><p>Take a look at the source code of the several static methods to see what it does. Naturally, you also provide any <code>CS</code> styles, background brush, class name and others while creating a new factory - for all practical purposes it is the equivalent of Win32 class registration.</p><h3>Class <code>WindowCore</code></h3><p>Now this is the class where all the magic happens. It provides the actual connection by attaching your handle and connecting your <code>WindowProc</code> to the class instances. If you look at the internals of <code>ATL</code> code, this is done using a concept called <code>thunking</code> and its done in assembly which may seem like dark magic to many. However, <code>WinApi</code> does this very transparently, and with no performance impact.</p><p>It does this with the help of <code>WindowFactory</code>, and swapping out its procedure during the creation of the window (more precisely during the <code>WM_NCCREATE</code> message).</p><p>Once it provides the connections, the <code>OnMessage</code> instance method can be used directly from C# to process the messages.</p><p><code>WindowCore</code> is still a super light weight class that does no message processing. Its stays completely out of the way, except for being able to control your message loop. But the keyword is <code>being able</code>. It doesn't not by default process any message by itself. Its simply passes it down to it default procedure. This is the lightest class that's fully functional.</p><h3>Class <code>EventedWindowCore</code></h3><p>Directly derived from <code>WindowCore</code> is the <code>EventedWindowCore</code> - this class decodes all the window messages, and breaks it down to its components, and passes them down to the relatives class instance's event methods.</p><p>For example</p><pre><code><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">MainWindow</span> <span class="token punctuation">:</span> <span class="token class-name">EventedWindowCore</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnCreate</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">CreateWindowPacket</span> packet<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnCreate</span><span class="token punctuation">(</span><span class="token keyword">ref</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnSize</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">SizePacket</span> packet<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> size <span class="token operator">=</span> packet<span class="token punctuation">.</span>Size<span class="token punctuation">;</span>
        <span class="token keyword">var</span> flags <span class="token operator">=</span> packet<span class="token punctuation">.</span>Flag<span class="token punctuation">;</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnSize</span><span class="token punctuation">(</span><span class="token keyword">ref</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Internally it uses the <code>Packetizer</code> class that simples create a corresponding <code>Packet</code> struct, and transparently decodes every message into its parameters. The <code>EventedWindowCore</code> handles most of the common window messages. That's actually all it does. The implementation can be thought of as nothing but one giant switch case that does simply creates a packet and propagates the packet to its appropriate handler method.</p><p>For example,</p><pre><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token keyword">void</span> <span class="token function">ProcessMove</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">WindowMessage</span> msg<span class="token punctuation">,</span> <span class="token class-name">EventedWindowCore</span> window<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">fixed</span> <span class="token punctuation">(</span>WindowMessage<span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token operator">&</span>msg<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> packet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MovePacket</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        window<span class="token punctuation">.</span><span class="token function">OnMove</span><span class="token punctuation">(</span><span class="token keyword">ref</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>This is the implementation for <code>WM_MOVE</code> handler. The <code>MovePacket</code> provides a very nice way to handle <code>WM_MOVE</code>, since it can both decode or encode the WM_MOVE messages into its parameter. It has the property <code>Point</code> as one of its properties.</p><p>So, similar to ATL/WTL, if you use the <code>WindowCore</code> you could manually build only the events you want to handle, by using the corresponding <code>Packet</code> manually - though in really, there's really no reason to do it, since the <code>JIT</code> will optimize away the <code>EventedWindowCore</code> to give you similar code in the end.</p><p>You can use the <code>EventedWindowCore</code>, derive all its benefits, but yet maintain performance very similar to writing native code in <code>ATL</code> with C++. However, for some reason you still want to use <code>WindowCore</code>, simply create the packet, to be able to decode the messages and build the logic manually, as you like. No more dealing with <code>wparam</code> and <code>lparam</code>.</p><p>Infact, the way <code>EventedWindowCore</code> is implemented very similar to this:</p><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EventedWindowCore</span> <span class="token punctuation">:</span> <span class="token class-name">WindowCore</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token function">OnMessage</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">WindowMessage</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>Id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">case</span> WM<span class="token punctuation">.</span>MOVE <span class="token punctuation">{</span>
                Packetizer<span class="token punctuation">.</span><span class="token function">ProcessMove</span><span class="token punctuation">(</span><span class="token keyword">ref</span> msg<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">OnMessageDefault</span><span class="token punctuation">(</span><span class="token keyword">ref</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">protected</span> <span class="token keyword">internal</span> <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">OnMove</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">MovePacket</span> packet<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Call the OnMessageDefault here.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code></pre><p>And in the above case <code>OnMessageDefault</code> translates into calling the base window procedure, which would be the <code>DefWindowProc</code> method in <code>user32.dll</code> if its an plain window, or the window's default procedure if its an in-built class like <code>STATIC</code>, <code>EDIT</code>, etc.</p><p>Also, the every single <code>Packet</code> variant is highly optimized to pass values on without any marshalling and additional copies of data. Even though many of the pointers are very naturally exposed in C# as its counterpart structs, they involve no additional copying. It uses very neat interop techniques to perform <code>reinterpret</code> casting across the C# managed boundary.</p><h2>Putting it all together</h2><pre><code><span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Window is just a wrapper over EventedWindowCore,</span>
        <span class="token comment">// that provides more convinience methods, which has</span>
        <span class="token comment">// its own self registered factory.</span>
        <span class="token comment">//</span>
        <span class="token comment">// Window is a part of WinApi.Windows.Controls.</span>
        <span class="token comment">//</span>
        <span class="token comment">// Samples contain code that also directly initiates</span>
        <span class="token comment">// EventedWindowCore without depending on </span>
        <span class="token comment">// WinApi.Windows.Controls simply by creating </span>
        <span class="token comment">// WindowFactory</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> win <span class="token operator">=</span> Window<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Create</span><span class="token punctuation">&lt;</span><span class="token class-name">AppWindow</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            win<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppWindow</span> <span class="token punctuation">:</span> <span class="token class-name">Window</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnMove</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">MovePacket</span> packet<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnMove</span><span class="token punctuation">(</span><span class="token keyword">ref</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnMessage</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">WindowMessage</span> msg<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Note: OnEraseBkgnd method is already available in </span>
            <span class="token comment">// EventedWindowCore, but directly intercepted here</span>
            <span class="token comment">// just for the sake of overriding the</span>
            <span class="token comment">// message loop.</span>
            <span class="token comment">// Also, note that the message loop is </span>
            <span class="token comment">// short-cicuited here.</span>

            <span class="token keyword">case</span> WM<span class="token punctuation">.</span>ERASEBKGND<span class="token punctuation">:</span>
            <span class="token punctuation">{</span>
                <span class="token comment">// I can even build the loop only on pay-per-use</span>
                <span class="token comment">// basis, when I need it since all the Packets decoding,</span>
                <span class="token comment">// and encoding are cleanly abstracted away into the Packet</span>
                <span class="token comment">// structs itself.</span>
                <span class="token comment">//</span>
                <span class="token comment">// fixed (var msgPtr = &msg)</span>
                <span class="token comment">// {</span>
                <span class="token comment">//    var packet = new EraseBkgndPacket(msg);</span>
                <span class="token comment">//    // Do anything you want with the packet.</span>
                <span class="token comment">// }</span>
                <span class="token comment">// return;</span>

                msg<span class="token punctuation">.</span>Result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntPtr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnMessage</span><span class="token punctuation">(</span><span class="token keyword">ref</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>The Samples included in the <code>WinApi</code> repository also has several programs that use DirectX, OpenGL, Skia, to paint windows. There are tons of other things that <code>WinApi</code> does, including one of the simplest ways of using <code>SendInput</code> with the helpers built right in, <code>DxUtils</code> that relives all the pain of managing the numerous Direct3D, Direct2D and also manages its versioning with ease, all while maintaining high-performance without any pressure on the GC.</p><p>Hopefully, I'll have the time to write about more of those later. But there's already <code>Sample.SimulateInput</code> as an example of <code>SendInput</code> and <code>Sample.DirectX</code> demonstrating <code>DxUtils</code> in the repo.</p></article></main><footer class="mt-4"><hr><aside class="my-3"><p><a href="https://www.twitter.com/prasannavl">@prasannavl</a> - If you enjoyed this post, please <a href="https://twitter.com/intent/tweet?url=https://www.prasannavl.com/2016/10/introducing-winapi-basics/" target="_blank">share it with your followers</a>.</p></aside><hr><nav class="clearfix footer-nav"><ul class="float-left list-inline"><li class="list-inline-item"><a href="javascript:window.scroll(0,0)">Top</a></li><li class="list-inline-item"><a href="/">Home</a></li><li class="list-inline-item"><a href="/archives/">Archives</a></li></ul></nav><p class="small text-muted mb-0 mt-1"><strong>Copyright  2020 <a href="/">Prasanna Loganathar</a></strong>. Blog content, design elements or any information without a direct or indirect license is licensed under <a href="https://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons CC BY 4.0</a>. Similarly, any such code fragments are licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0" rel="license">Apache 2.0 License</a>.</p></footer></div></div></div></div><div id="nprogress" style="transition:all .4s linear 0s;opacity:0"><div class="bar" role="bar" style="transform:translate3d(0,0,0);transition:all .4s ease 0s"><div class="peg"></div></div><div class="spinner" role="spinner"><div class="spinner-icon"></div></div></div></body></html>