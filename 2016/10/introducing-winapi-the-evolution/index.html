<!DOCTYPE html><html class="nprogress-busy" lang="en"><head><meta charset="utf-8"><meta content="ie=edge" http-equiv="x-ua-compatible"><link href="/css/index.8abdea1f0a4fab97fb2a612d0a6c8fe1.css" rel="stylesheet"><script defer src="/js/runtime.e8b300f0556ed5d0c4aa.js" type="text/javascript"></script><script defer src="/js/vendor.2214c7d88e9dd54634d1.js" type="text/javascript"></script><script defer src="/js/index.e332e09cc7e67f046901.js" type="text/javascript"></script><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MZ2DHR');</script><!-- End Google Tag Manager --><script defer src="/js/chunks/common-index.9d929302abc5499a1dd6.js" type="text/javascript" charset="utf-8"></script><script defer src="/js/chunks/91658ef1e7bd6690fa9447faa5f40551.0cbb0270338f9b3ab9d1.js" type="text/javascript" charset="utf-8"></script><script defer src="/js/chunks/fd386dadc1cf9935e5882fcfbf40fb5d.414378448a6a68d300e3.js" type="text/javascript" charset="utf-8"></script><title>Introducing WinApi: The Evolution | Prasanna Loganathar</title><link href="/icons/favicon-32x32.png" rel="icon" data-react-helmet="true" sizes="32x32" type="image/png"><link href="/icons/favicon-96x96.png" rel="icon" data-react-helmet="true" sizes="96x96" type="image/png"><link href="/icons/favicon-16x16.png" rel="icon" data-react-helmet="true" sizes="16x16" type="image/png"><link href="/favicon.ico" rel="shortcut icon" data-react-helmet="true" type="image/x-icon"><link href="/icons/apple-touch-icon-57x57.png" rel="apple-touch-icon" data-react-helmet="true" sizes="57x57"><link href="/icons/apple-touch-icon-60x60.png" rel="apple-touch-icon" data-react-helmet="true" sizes="60x60"><link href="/icons/apple-touch-icon-72x72.png" rel="apple-touch-icon" data-react-helmet="true" sizes="72x72"><link href="/icons/apple-touch-icon-76x76.png" rel="apple-touch-icon" data-react-helmet="true" sizes="76x76"><link href="/icons/apple-touch-icon-114x114.png" rel="apple-touch-icon" data-react-helmet="true" sizes="114x114"><link href="/icons/apple-touch-icon-120x120.png" rel="apple-touch-icon" data-react-helmet="true" sizes="120x120"><link href="/icons/apple-touch-icon-144x144.png" rel="apple-touch-icon" data-react-helmet="true" sizes="144x144"><link href="/icons/apple-touch-icon-152x152.png" rel="apple-touch-icon" data-react-helmet="true" sizes="152x152"><link href="/icons/apple-touch-icon-180x180.png" rel="apple-touch-icon" data-react-helmet="true" sizes="180x180"><link href="/icons/safari-pinned-tab.svg" rel="mask-icon" data-react-helmet="true" color="#0096d6"><link href="/manifest.json" rel="manifest" data-react-helmet="true"><link href="https://www.prasannavl.com/rss.xml" rel="alternate" data-react-helmet="true" type="application/rss+xml"><link href="https://www.prasannavl.com/sitemap.xml" rel="sitemap" data-react-helmet="true"><meta content="Prasanna Loganathar's Weblog" data-react-helmet="true" name="description"><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" data-react-helmet="true" name="viewport"><meta content="#0096d6" data-react-helmet="true" name="msapplication-TileColor"><meta content="/icons/mstile-144x144.png" data-react-helmet="true" name="msapplication-TileImage"><meta content="/browserconfig.xml" data-react-helmet="true" name="msapplication-config"><meta content="summary" data-react-helmet="true" name="twitter:card"><meta content="@prasannavl" data-react-helmet="true" name="twitter:site"><meta content="@prasannavl" data-react-helmet="true" name="twitter:creator"><meta content="Introducing WinApi: The Evolution" data-react-helmet="true" name="twitter:title"><meta content="Article on WinApi - Part 1" data-react-helmet="true" name="twitter:description"><meta content="Introducing WinApi: The Evolution" data-react-helmet="true" property="og:title"><meta content="Prasanna Loganathar" data-react-helmet="true" property="og:site_name"><meta content="article" data-react-helmet="true" property="og:type"><meta content="Article on WinApi - Part 1" data-react-helmet="true" property="og:description"><meta content="https://www.prasannavl.com//icons/mstile-310x310.png" data-react-helmet="true" property="og:image"><meta content="http://localhost:45678/2016/10/introducing-winapi-the-evolution/" data-react-helmet="true" property="og:url"><meta content="Prasanna Loganathar" data-react-helmet="true" property="og:article:author"><meta content="2016-10-22T13:51:30.195Z" data-react-helmet="true" property="og:article:article:published_time"></head><body><!-- Google Tag Manager (noscript) --><noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-MZ2DHR" style="display:none;visibility:hidden" width="0"></iframe></noscript><!-- End Google Tag Manager (noscript) --><div id="root"><div class="app-container container-fluid"><div class="row"><div class="col col-md-8 offset-md-2"><header class="banner"><h1 id="top"><a href="/">Prasanna Loganathar</a></h1><p>Explore more of <a href="/">my blog</a>, <a href="/archives/">archives</a> or subscribe to my <a href="/rss.xml" rel="alternate" type="application/rss+xml">feed</a>.</p><hr></header><main role="main"><article><header class="mb-4"><h1 class="title" rel="title">Introducing WinApi: The Evolution</h1><p class="d-none" rel="author">Prasanna Loganathar</p><p class="small text-muted" rel="date"><time datetime="2016-10-22T13:51:30.195Z">Saturday, 22nd Oct 2016</time></p></header><p><b>GitHub: </b><a href="https://github.com/prasannavl/WinApi">WinApi</a></p><p>The Windows API is over two decades old - yet one of the most used APIs that has stood the test of time. In today's short lived software world, you don't see a lot of user mode public APIs that stay the same for even a short time. But even a program that was written 20 years ago (assuming only the official and documented APIs by Microsoft were used) will run spot-on as intended, with almost no changes - That's quite cool if you think about it. You can't say that even about some of the oldest user mode UNIX APIs. It's a testimony to the well-design architecture and the amount of work Microsoft put into compatibility while modernizing everything both underneath, and above it, while keeping the core user mode APIs exactly the same.</p><h2>The good old C-lang way</h2><p>A <code>Hello World</code> of Windows, in C today, would resemble something like this below.</p><pre><code><span class="token macro property">#<span class="token keyword directive">define</span> UNICODE</span>
<span class="token macro property">#<span class="token keyword directive">define</span> _UNICODE</span>
<span class="token macro property">#<span class="token keyword directive">define</span> WIN32_LEAN_AND_MEAN</span>

<span class="token macro property">#<span class="token keyword directive">include</span> <span class="token string">&lt;windows.h></span></span>
<span class="token macro property">#<span class="token keyword directive">include</span> <span class="token string">&lt;iostream></span></span>

<span class="token keyword">int</span> WINAPI <span class="token function">wWinMain</span><span class="token punctuation">(</span>HINSTANCE hInstance<span class="token punctuation">,</span> HINSTANCE hPrevInstance<span class="token punctuation">,</span>
        PWSTR pCmdLine<span class="token punctuation">,</span> <span class="token keyword">int</span> nCmdShow<span class="token punctuation">)</span><span class="token punctuation">;</span>
LRESULT CALLBACK <span class="token function">WindowProc</span><span class="token punctuation">(</span>HWND hwnd<span class="token punctuation">,</span> UINT uMsg<span class="token punctuation">,</span> WPARAM wParam<span class="token punctuation">,</span>
        LPARAM lParam<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">wmain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">wWinMain</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">,</span> nullptr<span class="token punctuation">,</span> nullptr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> WINAPI <span class="token function">wWinMain</span><span class="token punctuation">(</span>HINSTANCE hInstance<span class="token punctuation">,</span> HINSTANCE hPrevInstance<span class="token punctuation">,</span> 
    PWSTR pCmdLine<span class="token punctuation">,</span> <span class="token keyword">int</span> nCmdShow<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    WNDCLASSEX wc <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    wc<span class="token punctuation">.</span>hInstance <span class="token operator">=</span> hInstance<span class="token punctuation">;</span>
    wc<span class="token punctuation">.</span>lpszClassName <span class="token operator">=</span> L<span class="token string">"MainWindow"</span><span class="token punctuation">;</span>
    wc<span class="token punctuation">.</span>cbSize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>WNDCLASSEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
    wc<span class="token punctuation">.</span>hIcon <span class="token operator">=</span> <span class="token function">LoadIcon</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">,</span> IDI_APPLICATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
    wc<span class="token punctuation">.</span>hCursor <span class="token operator">=</span> <span class="token function">LoadCursor</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">,</span> IDC_ARROW<span class="token punctuation">)</span><span class="token punctuation">;</span>
    wc<span class="token punctuation">.</span>style <span class="token operator">=</span> CS_HREDRAW <span class="token operator">|</span> CS_VREDRAW<span class="token punctuation">;</span>
    wc<span class="token punctuation">.</span>lpfnWndProc <span class="token operator">=</span> WindowProc<span class="token punctuation">;</span>
    <span class="token keyword">auto</span> regRes <span class="token operator">=</span> <span class="token function">RegisterClassEx</span><span class="token punctuation">(</span><span class="token operator">&</span>wc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>regRes<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token operator">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"window registration failed"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> regRes<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">auto</span> hwnd <span class="token operator">=</span> <span class="token function">CreateWindowEx</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> wc<span class="token punctuation">.</span>lpszClassName<span class="token punctuation">,</span> L<span class="token string">"Hello"</span><span class="token punctuation">,</span> 
        WS_OVERLAPPEDWINDOW<span class="token punctuation">,</span> CW_USEDEFAULT<span class="token punctuation">,</span> CW_USEDEFAULT<span class="token punctuation">,</span> CW_USEDEFAULT<span class="token punctuation">,</span>
        CW_USEDEFAULT<span class="token punctuation">,</span> nullptr<span class="token punctuation">,</span> nullptr<span class="token punctuation">,</span> hInstance<span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hwnd <span class="token operator">==</span> nullptr<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token operator">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"window couldn't be created"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">ShowWindow</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> SW_SHOWNORMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    MSG msg <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">GetMessage</span><span class="token punctuation">(</span><span class="token operator">&</span>msg<span class="token punctuation">,</span> nullptr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">TranslateMessage</span><span class="token punctuation">(</span><span class="token operator">&</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">DispatchMessage</span><span class="token punctuation">(</span><span class="token operator">&</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

LRESULT <span class="token function">HandleDestroy</span><span class="token punctuation">(</span>HWND hWnd<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">PostQuitMessage</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

LRESULT <span class="token function">HandlePaint</span><span class="token punctuation">(</span>HWND hwnd<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    PAINTSTRUCT ps<span class="token punctuation">;</span>
    <span class="token keyword">auto</span> hdc <span class="token operator">=</span> <span class="token function">BeginPaint</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> <span class="token operator">&</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FillRect</span><span class="token punctuation">(</span>hdc<span class="token punctuation">,</span> <span class="token operator">&</span>ps<span class="token punctuation">.</span>rcPaint<span class="token punctuation">,</span> <span class="token punctuation">(</span>HBRUSH<span class="token punctuation">)</span><span class="token punctuation">(</span>COLOR_WINDOW<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">EndPaint</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> <span class="token operator">&</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

LRESULT CALLBACK <span class="token function">WindowProc</span><span class="token punctuation">(</span>HWND hwnd<span class="token punctuation">,</span> UINT uMsg<span class="token punctuation">,</span> WPARAM wParam<span class="token punctuation">,</span> LPARAM lParam<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>uMsg<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token keyword">case</span> WM_ERASEBKGND<span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> WM_DESTROY<span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token function">HandleDestroy</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> WM_PAINT<span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token function">HandlePaint</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">DefWindowProc</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> uMsg<span class="token punctuation">,</span> wParam<span class="token punctuation">,</span> lParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Unfortunately, about half the programmers I meet today never use this kind of code, and even less knew exactly what each codepath did underneath - They were simply never accustomed to writing low-level code. While the above is not assembly, it may still show some age. However, it's still the most performant and the most reliable way to run software on the Windows ecosystem. While frameworks on top it - MFC, WinForms, WPF, and the more modern Windows Runtime all provide great convenience, its the raw APIs that you end up dipping into inevitably in more than just a few scenarios. Until Windows Runtime came along, ATL/WTL has been the most fantastic of all - Not because it provides some unmatched great feature, but because it stays closest to bare metal, and yet managed to provide a very clever way of writing code, productively and with high-efficiency. It essentially translates almost exactly into code similar to the above right before compilation.</p><h2>The C++ way</h2><p>So, here's how the same piece of code in ATL/WTL today, with modern C++:</p><pre><code><span class="token macro property">#<span class="token keyword directive">define</span> UNICODE</span>
<span class="token macro property">#<span class="token keyword directive">define</span> _UNICODE</span>
<span class="token macro property">#<span class="token keyword directive">define</span> WIN32_LEAN_AND_MEAN</span>
<span class="token macro property">#<span class="token keyword directive">include</span> <span class="token string">&lt;windows.h></span></span>

<span class="token macro property">#<span class="token keyword directive">include</span> <span class="token string">&lt;wrl.h></span></span>
<span class="token macro property">#<span class="token keyword directive">include</span> <span class="token string">&lt;atlbase.h></span></span>
<span class="token macro property">#<span class="token keyword directive">include</span> <span class="token string">&lt;atlapp.h></span></span>
<span class="token macro property">#<span class="token keyword directive">include</span> <span class="token string">&lt;atlwin.h></span></span>
<span class="token macro property">#<span class="token keyword directive">include</span> <span class="token string">&lt;atlmisc.h></span></span>
<span class="token macro property">#<span class="token keyword directive">include</span> <span class="token string">&lt;atlcrack.h></span></span>

<span class="token keyword">class</span> <span class="token class-name">CAppWindow</span> <span class="token operator">:</span> <span class="token keyword">public</span> CWindowImpl<span class="token operator">&lt;</span>CAppWindow<span class="token punctuation">,</span> CWindow<span class="token punctuation">,</span> CFrameWinTraits<span class="token operator">></span>
<span class="token punctuation">{</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token function">BEGIN_MSG_MAP</span><span class="token punctuation">(</span>CAppWindow<span class="token punctuation">)</span>
        <span class="token function">MSG_WM_DESTROY</span><span class="token punctuation">(</span>OnDestroy<span class="token punctuation">)</span>
        <span class="token function">MSG_WM_PAINT</span><span class="token punctuation">(</span>OnPaint<span class="token punctuation">)</span>
        <span class="token function">MSG_WM_ERASEBKGND</span><span class="token punctuation">(</span>OnEraseBkgnd<span class="token punctuation">)</span>
    <span class="token function">END_MSG_MAP</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">DECLARE_WND_CLASS_EX</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">protected</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">OnDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LRESULT <span class="token function">OnEraseBkgnd</span><span class="token punctuation">(</span>HDC hdc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">OnPaint</span><span class="token punctuation">(</span>HDC hdc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> CAppWindow<span class="token operator">::</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">auto</span> hwnd <span class="token operator">=</span> <span class="token function">Create</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> L<span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ShowWindow</span><span class="token punctuation">(</span>SW_SHOWNORMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    MSG msg<span class="token punctuation">;</span>
    BOOL result<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>result <span class="token operator">=</span> <span class="token function">GetMessage</span><span class="token punctuation">(</span><span class="token operator">&</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">TranslateMessage</span><span class="token punctuation">(</span><span class="token operator">&</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">DispatchMessage</span><span class="token punctuation">(</span><span class="token operator">&</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> CAppWindow<span class="token operator">::</span><span class="token function">OnDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">PostQuitMessage</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

LRESULT CAppWindow<span class="token operator">::</span><span class="token function">OnEraseBkgnd</span><span class="token punctuation">(</span>HDC hdc<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">SetMsgHandled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> CAppWindow<span class="token operator">::</span><span class="token function">OnPaint</span><span class="token punctuation">(</span>HDC hdc<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    PAINTSTRUCT ps<span class="token punctuation">;</span>
    <span class="token function">BeginPaint</span><span class="token punctuation">(</span><span class="token operator">&</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FillRect</span><span class="token punctuation">(</span>hdc<span class="token punctuation">,</span> <span class="token operator">&</span>ps<span class="token punctuation">.</span>rcPaint<span class="token punctuation">,</span> <span class="token punctuation">(</span>HBRUSH<span class="token punctuation">)</span>COLOR_WINDOW<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">EndPaint</span><span class="token punctuation">(</span><span class="token operator">&</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SetMsgHandled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">wWinMain</span><span class="token punctuation">(</span>HINSTANCE hInstance<span class="token punctuation">,</span> HINSTANCE<span class="token punctuation">,</span> LPWSTR<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    CAppWindow win<span class="token punctuation">;</span>
    <span class="token keyword">return</span> win<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Far better. However, it does show its age. Nonetheless, its as good as it gets when you want to stick to C/C++, and is also the approach I'd recommend today for native applications, unless you switch over to the more modern Windows Runtime.</p><h2>What has changed today</h2><p>In modern software, some of the most overlooked pieces of technology are the compilers, JIT, code analyzers and optimizers. They are not what they were 10 years ago, or what people tend to learn in schools, not even the most advanced courses in the best of schools have today's architecture. With technologies like <code>LLVM</code>, <code>Roslyn</code>, <code>RyuJIT</code> - They're fundamentally very different and far more advanced than most imagine. Its practically the Batman of modern computing - The most appropriate way to describe would be this quote from the <em>Dark Knight</em>:</p><blockquote class="blockquote note">The silent guardian, a watchful protector.<footer class="blockquote-footer"><cite>The Dark Knight</cite></footer></blockquote><p>Not just figuratively, but they are quite literally the guardians and protectors of memory safety. They are what created the world as it is today, with people across the globe being able to create great things even with no knowledge of the core APIs underneath (That's both advantageous, and disastrous. I'd say its <code>one of the reasons why a majority of the softwares are still so inconsistent with questionable reliability, and even worse - making unreliability the socially acceptable norm</code>). On the other hand, it has given an opportunity for a great many number of inventions, since it lowered the learning curve exponentially - which would have been cumbersome otherwise and restricted high-grade software to an elite few.</p><p>When many of these were designed a few years ago, it was generally found to be pleasant that the these abstractions hid away everything underneath. But the fact is, it diverged the application ecosystem into many forked paths, each with its own learning curve, complications, and deviations. Windows APIs got older, less used directly.</p><h2>Enter the CLR, <span>C#</span></h2><p>It should be obvious now that the CLR is like Batman in the managed Windows world. The CLR is the one protecting you from shooting yourself in your feet. But there's a very astutue change, that most other managed languages like Java, Python or Javascript was never designed to do - You can tell the CLR - <code>Hey, I know what I'm doing - If I shoot my self in the feet, I'm doing it for a reason</code>. With the so called <code>unsafe</code> context, the CLR steps completely out of the way, trusting you implicitly. Pointer arithmetic, reinterpretation casts, you can do it all. Sometimes, even Bruce Wayne needs to be taught he is not always right. It allows you to play Alfred, and to make very personal choices for the Bat.</p><p>With the CLR, came WinForms - Microsoft's recommended way of accessing the Windows API with the CLR. If you take a peek into the history, WinForms was designed with one great purpose - To make the Windows API cool again. It was to use the CLR to provide a very neat way of writing code where the memory is (almost) entirely managed by the CLR. However, there were also decisions made, to abstract things much further than just memory, and create another ecosystem that have no resemblance to the native layers underneath - And it was a great decision to do so, at that time. While Java is just a historic footnote to the .NET community today, with C# on CLR far exceeding the productivity and efficiency of the Java ecosystem, it still probably owes its thanks to Java in its initial stages, where it picked up those traits.</p><p>And soon, the above code, looked something like this:</p><pre><code><span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token class-name">STAThread</span><span class="token punctuation">]</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Application<span class="token punctuation">.</span><span class="token function">EnableVisualStyles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Application<span class="token punctuation">.</span><span class="token function">SetCompatibleTextRenderingDefault</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Application<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MainWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">MainWindow</span> <span class="token punctuation">:</span> <span class="token class-name">Form</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">MainWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">InitializeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Looks much nicer. But lets get the fact that this is not C++ out of the way first - in most scenarios the advanced capabilities really aren't required and you can always use C++ when you really need and simply PInvoke even though <code>a C# idiomatic high-performance solution almost always exists as well - with techniques like memory pooling, structs, and stackalloc</code>. Because, when you realize you need such optimizations especially memory pooling, chances are C/C++ would benefit with memory pooling as well. And <strong>once you start efficiently pooling memory and reducing the GC pressure, the performance differences between the two languages start to disappear for the most part</strong>. That aside, there are still some inherent problems.</p><p>Even though it used all the native layers, <code>it provided no way to use any of them directly without going through the abstractions</code> - which actually makes a lot of sense since you want new APIs to be built on the abstractions, not the layers below. But fast-forward a decade later - and its not exactly as appealing as it once was. While most of the abstractions make sense, the inability to access the native layers without a whole bunch of redundant PInvoke isn't.</p><p>This also comes with the GC tax - <code>Every message sent to a Windows Message Loop, ends up adding pressure to GC</code>. While much of this is very well optimized today, and practically a non-issue - for high-performance scenarios like games, and high-frame rate AV, it does come into significance.</p><p>However, the most important problem - <code>it deviates from the raw Windows API</code>. For example, it introduces concepts like <code>ControlStyles</code>, which changes the behavior which in many occasions is completely different from how the raw Windows API handles it. There are many circumstances where the default behavior changes, even though subtle and small - <code>it adds up, and now you have to learn a whole new API and understand its quirks</code>. It also uses GDI+, which is not always required, when you either just want the GDI for simple optimized tasks, or you use DirectX. And its adds quite a few hefty system images as dependencies.</p><h2>Enter WinApi</h2><p>Apart from WinForms, there's really no other idiomatic way to access the Windows API from C#. That's quite disconcerting if you don't want to pay the prices mentioned above. Well, there's WPF - but that's a parallel framework, which is built off Direct2D and Direct3D technologies, instead of GDI plus that WinForms relies on. It doesn't really concern itself with the Windows API.</p><p>What if you'd like to combine, GDI, DirectX, and GDI plus. There's no clean way to do this in .NET. But a more practical requirement, is you want to control the underlying graphics technology, and use a framework like Cario, Skia or raw DirectX.</p><p>All of this brought me to this - <strong>We need a clean, stable way to access the Windows API from .NET.</strong> And along the way, I also decided to solve the above mentioned issues with WinForms.</p><p>And that brings us to <code>WinApi</code> which ultimately lets you do this below, while solving all of the problems above:</p><pre><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> win <span class="token operator">=</span> Window<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>text<span class="token punctuation">:</span> <span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        win<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>I'll discuss more about how it solves the problems, and how to use it in the next article.</p></article></main><footer class="mt-4"><hr><aside class="my-3"><p><a href="https://www.twitter.com/prasannavl">@prasannavl</a> - If you enjoyed this post, please <a href="https://twitter.com/intent/tweet?url=https://www.prasannavl.com/2016/10/introducing-winapi-the-evolution/" target="_blank">share it with your followers</a>.</p></aside><hr><nav class="clearfix footer-nav"><ul class="float-left list-inline"><li class="list-inline-item"><a href="javascript:window.scroll(0,0)">Top</a></li><li class="list-inline-item"><a href="/">Home</a></li><li class="list-inline-item"><a href="/archives/">Archives</a></li></ul></nav><p class="small text-muted mb-0 mt-1"><strong>Copyright Â© 2020 <a href="/">Prasanna Loganathar</a></strong>. Blog content, design elements or any information without a direct or indirect license is licensed under <a href="https://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons CC BY 4.0</a>. Similarly, any such code fragments are licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0" rel="license">Apache 2.0 License</a>.</p></footer></div></div></div></div><div id="nprogress" style="transition:all .4s linear 0s;opacity:0"><div class="bar" role="bar" style="transform:translate3d(0,0,0);transition:all .4s ease 0s"><div class="peg"></div></div><div class="spinner" role="spinner"><div class="spinner-icon"></div></div></div></body></html>