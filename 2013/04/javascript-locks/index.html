<!DOCTYPE html><html class="nprogress-busy" lang="en"><head><meta charset="utf-8"><meta content="ie=edge" http-equiv="x-ua-compatible"><link href="/css/index.8abdea1f0a4fab97fb2a612d0a6c8fe1.css" rel="stylesheet"><script defer src="/js/runtime.e8b300f0556ed5d0c4aa.js" type="text/javascript"></script><script defer src="/js/vendor.2214c7d88e9dd54634d1.js" type="text/javascript"></script><script defer src="/js/index.e332e09cc7e67f046901.js" type="text/javascript"></script><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MZ2DHR');</script><!-- End Google Tag Manager --><script defer src="/js/chunks/common-index.9d929302abc5499a1dd6.js" type="text/javascript" charset="utf-8"></script><script defer src="/js/chunks/de7dadd5f1766e7b9c4fb0be29b49849.782af9975602808232f5.js" type="text/javascript" charset="utf-8"></script><script defer src="/js/chunks/fd386dadc1cf9935e5882fcfbf40fb5d.414378448a6a68d300e3.js" type="text/javascript" charset="utf-8"></script><title>Javascript Locks | Prasanna Loganathar</title><link href="/icons/favicon-32x32.png" rel="icon" data-react-helmet="true" sizes="32x32" type="image/png"><link href="/icons/favicon-96x96.png" rel="icon" data-react-helmet="true" sizes="96x96" type="image/png"><link href="/icons/favicon-16x16.png" rel="icon" data-react-helmet="true" sizes="16x16" type="image/png"><link href="/favicon.ico" rel="shortcut icon" data-react-helmet="true" type="image/x-icon"><link href="/icons/apple-touch-icon-57x57.png" rel="apple-touch-icon" data-react-helmet="true" sizes="57x57"><link href="/icons/apple-touch-icon-60x60.png" rel="apple-touch-icon" data-react-helmet="true" sizes="60x60"><link href="/icons/apple-touch-icon-72x72.png" rel="apple-touch-icon" data-react-helmet="true" sizes="72x72"><link href="/icons/apple-touch-icon-76x76.png" rel="apple-touch-icon" data-react-helmet="true" sizes="76x76"><link href="/icons/apple-touch-icon-114x114.png" rel="apple-touch-icon" data-react-helmet="true" sizes="114x114"><link href="/icons/apple-touch-icon-120x120.png" rel="apple-touch-icon" data-react-helmet="true" sizes="120x120"><link href="/icons/apple-touch-icon-144x144.png" rel="apple-touch-icon" data-react-helmet="true" sizes="144x144"><link href="/icons/apple-touch-icon-152x152.png" rel="apple-touch-icon" data-react-helmet="true" sizes="152x152"><link href="/icons/apple-touch-icon-180x180.png" rel="apple-touch-icon" data-react-helmet="true" sizes="180x180"><link href="/icons/safari-pinned-tab.svg" rel="mask-icon" data-react-helmet="true" color="#0096d6"><link href="/manifest.json" rel="manifest" data-react-helmet="true"><link href="https://www.prasannavl.com/rss.xml" rel="alternate" data-react-helmet="true" type="application/rss+xml"><link href="https://www.prasannavl.com/sitemap.xml" rel="sitemap" data-react-helmet="true"><meta content="Prasanna Loganathar's Weblog" data-react-helmet="true" name="description"><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" data-react-helmet="true" name="viewport"><meta content="#0096d6" data-react-helmet="true" name="msapplication-TileColor"><meta content="/icons/mstile-144x144.png" data-react-helmet="true" name="msapplication-TileImage"><meta content="/browserconfig.xml" data-react-helmet="true" name="msapplication-config"><meta content="summary" data-react-helmet="true" name="twitter:card"><meta content="@prasannavl" data-react-helmet="true" name="twitter:site"><meta content="@prasannavl" data-react-helmet="true" name="twitter:creator"><meta content="Javascript Locks" data-react-helmet="true" name="twitter:title"><meta content="Priority based work queues that emulate locking mechanism in JavaScript" data-react-helmet="true" name="twitter:description"><meta content="Javascript Locks" data-react-helmet="true" property="og:title"><meta content="Prasanna Loganathar" data-react-helmet="true" property="og:site_name"><meta content="article" data-react-helmet="true" property="og:type"><meta content="Priority based work queues that emulate locking mechanism in JavaScript" data-react-helmet="true" property="og:description"><meta content="https://www.prasannavl.com//icons/mstile-310x310.png" data-react-helmet="true" property="og:image"><meta content="http://localhost:45678/2013/04/javascript-locks/" data-react-helmet="true" property="og:url"><meta content="Prasanna Loganathar" data-react-helmet="true" property="og:article:author"><meta content="2013-04-27T00:00:00.000Z" data-react-helmet="true" property="og:article:article:published_time"></head><body><!-- Google Tag Manager (noscript) --><noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-MZ2DHR" style="display:none;visibility:hidden" width="0"></iframe></noscript><!-- End Google Tag Manager (noscript) --><div id="root"><div class="app-container container-fluid"><div class="row"><div class="col col-md-8 offset-md-2"><header class="banner"><h1 id="top"><a href="/">Prasanna Loganathar</a></h1><p>Explore more of <a href="/">my blog</a>, <a href="/archives/">archives</a> or subscribe to my <a href="/rss.xml" rel="alternate" type="application/rss+xml">feed</a>.</p><hr></header><main role="main"><article><header class="mb-4"><h1 class="title" rel="title">Javascript Locks</h1><p class="d-none" rel="author">Prasanna Loganathar</p><p class="small text-muted" rel="date"><time datetime="2013-04-27T00:00:00.000Z">Saturday, 27th Apr 2013</time></p></header><p class="note-red"><strong>Note:</strong> This article is here <em>only for historical reasons</em>. <strong>Do not ever do this</strong>, unless you know what you're doing. Also note that this is more of a task library than just for locking - this was a way to solve a particular problem I was facing. That being said, this is almost always a wrong approach for any problem in today's javascript ecosystem. :)</p><p>Things break. Codes break. Javascript - they don't just break, they break everything along with it. Being the simplest language has its downsides. But one of the common reasons that happen is people tend to forget that everything in JS is asynchronous.</p><p>You probably would get away with it, if you're writing simple applications. But when complexity increases, it almost becomes impossible to solve certain problems with the async design pattern, not without a locking mechanism. Especially, in a javascript environment due to its full async nature making timing absolutely unreliable and unpredictable. While locking is common in a multi-thread environment, Js in most common environments will run on a single-thread and due to only simple tasks being performed with it, the old days never saw a need for locking. But for today's complex applications, you just need performant and reliable locking. There's no way around it.</p><p>And that's exactly what the below tiny (&lt;2kb) library provides.</p><p><b>GitHub: </b><a href="https://github.com/prasannavl/JsLocks"><s>https://github.com/prasannavl/JsLocks</s></a> [No longer available]<br><b>Download: </b><a href="https://raw.github.com/prasannavl/JsLocks/master/JsLocks.min.js"><s>JsLocks.min.js</s></a> [No longer available]</p><h2>API</h2><pre><code>Locker<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span>lockName<span class="token punctuation">,</span> callbackFunction<span class="token punctuation">,</span> <span class="token punctuation">[</span>priority<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Locker<span class="token punctuation">.</span><span class="token function">LockManual</span><span class="token punctuation">(</span>lockName<span class="token punctuation">,</span> callbackFunction<span class="token punctuation">,</span> <span class="token punctuation">[</span>priority<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Locker<span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span>lockName<span class="token punctuation">)</span><span class="token punctuation">;</span>

Locker<span class="token punctuation">.</span><span class="token function">DiscardQueue</span><span class="token punctuation">(</span>lockName<span class="token punctuation">)</span><span class="token punctuation">;</span>

Locker<span class="token punctuation">.</span><span class="token function">LockManualIfInstant</span><span class="token punctuation">(</span>lockName<span class="token punctuation">,</span> callbackFunction<span class="token punctuation">,</span> <span class="token punctuation">[</span>priority<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Locker<span class="token punctuation">.</span><span class="token function">LockIfInstant</span><span class="token punctuation">(</span>lockName<span class="token punctuation">,</span> callbackFunction<span class="token punctuation">,</span> <span class="token punctuation">[</span>priority<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2>Basic usage</h2><pre><code><span class="token keyword">function</span> <span class="token function">getALife</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Locker<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token string">"thebiglock"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">DoSomeWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">FetchNewAjaxContentAndReplaceMyMainContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>You could see how the above just cannot work without locking. Without this locking, executing getALife even twice in a row, basically ruins your life. Since you have no idea when you'll get the ajax request back. You have no way of knowing if they will work in order. Instead, your requests will get mangled up, and you have no way to load items in parallel without messing up the order. While this is a simple example, its uses go much further.</p><p>The above is a auto-release lock. If you want manual control over the locks, just use the ManualLock and Release functions. It'd be incredibly useful to nest it deep down in the async callback hierarchy. Say, to couple it with jQuery animate's call back.</p><pre><code>Locker<span class="token punctuation">.</span><span class="token function">LockManual</span><span class="token punctuation">(</span><span class="token string">"thebiglock"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">DoSomeWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"MyLife"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">animate</span><span class="token punctuation">(</span> <span class="token string">"fast"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">FetchNewAjaxContentAndReplaceMyMainContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Locker<span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token string">"thebiglock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Now this makes it work exactly as you'd except. And you can call the Locker.Release from anywhere, even from an external call or not even at all (of course, in which case your tasks are going to keep getting piled up until you do.)</p><p>And last but not the least - Priorities.</p><pre><code>Locker<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token string">"thebiglock"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">DoSomeWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FetchNewAjaxContentAndReplaceMyMainContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The default priority of jobs is 10. Higher the value, higher the priority.</p><h2>Priority values example</h2><pre><code><span class="token keyword">var</span> <span class="token function function-variable">test</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">no</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> priority <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Locker<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token string">"t1"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Task no: "</span> <span class="token operator">+</span> no <span class="token operator">+</span> <span class="token string">", Priority: "</span> <span class="token operator">+</span> priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> 
    <span class="token function">test</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><h2>Output</h2><samp><pre><code>Task no: 0, Priority: 8
Task no: 1, Priority: 8
Task no: 4, Priority: 7
Task no: 6, Priority: 7
Task no: 9, Priority: 7
Task no: 8, Priority: 5
Task no: 2, Priority: 3
Task no: 5, Priority: 3
Task no: 7, Priority: 1
Task no: 3, Priority: 1</code></pre></samp><p>As you'd expect, the locking mechanism makes it a reliable tasking system. Extend, modify and utilize it at will. Have fun!</p></article></main><footer class="mt-4"><hr><aside class="my-3"><p><a href="https://www.twitter.com/prasannavl">@prasannavl</a> - If you enjoyed this post, please <a href="https://twitter.com/intent/tweet?url=https://www.prasannavl.com/2013/04/javascript-locks/" target="_blank">share it with your followers</a>.</p></aside><hr><nav class="clearfix footer-nav"><ul class="float-left list-inline"><li class="list-inline-item"><a href="javascript:window.scroll(0,0)">Top</a></li><li class="list-inline-item"><a href="/">Home</a></li><li class="list-inline-item"><a href="/archives/">Archives</a></li></ul></nav><p class="small text-muted mb-0 mt-1"><strong>Copyright © 2020 <a href="/">Prasanna Loganathar</a></strong>. Blog content, design elements or any information without a direct or indirect license is licensed under <a href="https://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons CC BY 4.0</a>. Similarly, any such code fragments are licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0" rel="license">Apache 2.0 License</a>.</p></footer></div></div></div></div><div id="nprogress" style="transition:all .4s linear 0s;opacity:0"><div class="bar" role="bar" style="transform:translate3d(0,0,0);transition:all .4s ease 0s"><div class="peg"></div></div><div class="spinner" role="spinner"><div class="spinner-icon"></div></div></div></body></html>